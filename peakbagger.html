<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Peakbagger‚Äôs Journal Web</title>

<!-- SEO -->
<meta name="description" content="Peakbagger‚Äôs Journal Web ‚Äî a private, offline-friendly checklist to track progress on the NH 48 and other peak lists. Toggle units, export to XLSX, and learn more about each mountain." />
<link rel="canonical" href="https://www.nh48pics.com/peakbagger" />
<meta name="robots" content="index,follow,max-image-preview:large" />

<!-- Open Graph -->
<meta property="og:type" content="website" />
<meta property="og:title" content="Peakbagger‚Äôs Journal Web" />
<meta property="og:description" content="Track your NH 48 and other lists privately, offline-friendly. Clean UI, XLSX export, mountain detail panel, and more." />
<meta property="og:url" content="https://www.nh48pics.com/peakbagger" />
<meta property="og:site_name" content="NH48pics" />
<meta property="og:image" content="https://www.nh48pics.com/_files/og/peakbagger-og.jpg" />

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Peakbagger‚Äôs Journal Web" />
<meta name="twitter:description" content="Private, offline-friendly checklist for NH 48 and more." />
<meta name="twitter:image" content="https://www.nh48pics.com/_files/og/peakbagger-og.jpg" />

<!-- JSON-LD: SoftwareApplication -->
<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@type":"SoftwareApplication",
  "name":"Peakbagger‚Äôs Journal Web",
  "applicationCategory":"LifestyleApplication",
  "operatingSystem":"Web",
  "author":{"@type":"Person","name":"Nathan Sobol"},
  "description":"A private, offline-friendly checklist to track peakbagging progress (e.g., NH 48), including units toggle, XLSX export, and a mountain detail panel.",
  "offers":{"@type":"Offer","price":"0","priceCurrency":"USD"},
  "url":"https://www.nh48pics.com/peakbagger"
}
</script>
    <!-- Collapsible details control (NEW) -->
    <script>
    // Collapse Settings and Resources by default on narrow screens
    document.addEventListener('DOMContentLoaded', function(){
      var settingsDetails = document.getElementById('settingsDetails');
      var resourcesDetails = document.getElementById('resourcesDetails');
      function toggleDetailsByWidth(){
        if (!settingsDetails || !resourcesDetails) return;
        if (window.innerWidth < 960) {
          // Collapse for stacked/mobile view
          settingsDetails.open = false;
          resourcesDetails.open = false;
        } else {
          // Expand on wider screens
          settingsDetails.open = true;
          resourcesDetails.open = true;
        }
      }
      toggleDetailsByWidth();
      window.addEventListener('resize', toggleDetailsByWidth);
    });
    </script>

    <style>
/* =============================================
   PEAKBAGGER ‚Äî CLEANED & CONSOLIDATED STYLES
   - Dark/Light tokens
   - App frame
   - Layout / components
   - Table card
   - Detail panel + modal
   - Accessibility / print
   - Mobile grid with top (rank/name/elev) & bottom (date/checkbox)
   - Grid Mode (month chips)
================================================ */

/* ---------- Design tokens ---------- */
:root{
  /* dark theme (default) */
  --bg:#0a0a0a; --panel:#121212; --card:#1a1a1a; --ink:#ffffff; --ink-weak:#d3d3d3;
  --border:#2a2a2a; --border-strong:#ffffff; --accent:#9cc8ff; --good:#3ddc84; --warn:#ffcc66;
  --input-bg:#1b1b1b; --input-bg-hover:#222; --chip-bg:#1a1a1a; --chip-border:#2a2a2a;
  --shadow:0 10px 35px rgba(0,0,0,.45);
  --ctrl-h:40px; --ctrl-gap:12px;
  /* column widths (desktop) */
  --col-rank:64px; --col-elev:140px; --col-date:160px; --col-done:120px; --col-arrow:48px;
}
.theme-light{
  --bg:#f8f8fb; --panel:#ffffff; --card:#ffffff; --ink:#111111; --ink-weak:#666666;
  --border:#dadde6; --border-strong:#000000; --accent:#2a6bff; --good:#1dbf73; --warn:#e6a100;
  --input-bg:#ffffff; --input-bg-hover:#f3f4f8; --chip-bg:#ffffff; --chip-border:#dadde6;
  --shadow:0 10px 35px rgba(0,0,0,.10);
}
/* Forest green theme */
.theme-forest{
  --bg:#07160e; --panel:#0b2a19; --card:#0f3a23; --ink:#eaf6ec; --ink-weak:#b6d6c2;
  --border:#12321e; --border-strong:#eaf6ec; --accent:#2fb86a; --good:#44c27a; --warn:#e6a100;
  --input-bg:#0b2a19; --input-bg-hover:#0f3a23; --chip-bg:#0b2a19; --chip-border:#12321e;
  --shadow:0 10px 35px rgba(0,0,0,.25);
}
/* Sky blue theme */
.theme-sky{
  --bg:#eaf6ff; --panel:#dff3ff; --card:#ffffff; --ink:#0b2340; --ink-weak:#4a6b86;
  --border:#bcdcf0; --border-strong:#0b2340; --accent:#3a96ff; --good:#1dbf73; --warn:#ffb74d;
  --input-bg:#ffffff; --input-bg-hover:#f3fbff; --chip-bg:#ffffff; --chip-border:#bcdcf0;
  --shadow:0 10px 35px rgba(0,0,0,.06);
}

/* ---------- Base / app frame ---------- */
*{box-sizing:border-box}
html, body { height:auto; min-height:100%; }
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.app{display:grid;grid-template-rows:auto 1fr;min-height:100vh;gap:16px;border:2px solid var(--border-strong);border-radius:10px;overflow:hidden}

/* ---------- Topbar ---------- */
.topbar{padding:16px;background:var(--panel);border-bottom:1px solid var(--border)}
.topbar .row1{display:flex;flex-direction:column;gap:12px}
.progress-wrap{width:100%}
.progress-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
.progress{height:10px;border:1px solid var(--border-strong);border-radius:999px;overflow:hidden;background:#000}
.bar{height:100%;background:#fff;width:0}
.list-title{flex:1;text-align:center;font-size:24px;font-weight:700;letter-spacing:.3px;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* ---------- Controls row ---------- */
.controls{display:grid;grid-template-columns:repeat(5,1fr);gap:var(--ctrl-gap);align-items:center}
.ctrl,.ctrl-btn{height:var(--ctrl-h);display:flex;align-items:center;gap:10px;background:var(--chip-bg);border:1px solid var(--chip-border);border-radius:999px;padding:0 14px;color:var(--ink)}
.ctrl input[type="search"]{flex:1;min-width:0;border:none;outline:none;background:transparent;color:inherit;height:calc(var(--ctrl-h) - 2px)}
.ctrl-btn{cursor:pointer;justify-content:center}
.ctrl-btn button{all:unset;color:inherit;cursor:pointer}
.ctrl .ico,.ctrl-btn .ico{font-size:14px;opacity:.9}

/* ---------- Content (sidebar + table) ---------- */
.content{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:0 16px 16px}
.sidebar{border:1px solid var(--border);background:var(--panel);border-radius:16px;padding:16px 14px 18px 16px}
.brand{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.brand h1{font-size:18px;margin:0}

/* (duplicate block consolidated) */
.subtle{color:var(--ink-weak);font-size:12px}
.sidebar .copyright{margin-top:10px;font-size:12px;color:var(--ink-weak)}
.auth{margin-top:10px;padding:10px;background:var(--card);border:1px solid var(--border);border-radius:12px}
.auth .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
.btn{border:1px solid var(--border-strong);color:var(--ink);background:transparent;border-radius:10px;padding:8px 10px;cursor:pointer}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.btn-ghost{border-color:var(--border);color:var(--ink)}
.btn-primary{border-color:var(--accent)}
.btn-small{padding:6px 8px;border-radius:8px;font-size:12px}
.select,select,.input{background:var(--input-bg);color:var(--ink);border:1px solid var(--border-strong);border-radius:10px;padding:8px 10px;outline:none}
select:focus,.input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(156,200,255,.15)}
select{width:100%}

/* ---------- iOS app promo card ---------- */
.sidebar .app-promo{display:flex;align-items:center;gap:10px;margin:8px 0 14px;padding:10px 12px;background:var(--card);color:var(--ink);text-decoration:none;border:1px solid var(--border);border-radius:12px;box-shadow:none}
.sidebar .app-promo:hover{ background:var(--input-bg-hover); }
.app-promo__icon{width:32px; height:32px; border-radius:8px;border:1px solid var(--border-strong); flex:0 0 auto;}
.app-promo__meta{ flex:1; min-width:0; }
.app-promo__title{ font-weight:700; line-height:1; margin:0 0 2px; }
.app-promo__sub{ font-size:12px; color:var(--ink-weak); line-height:1.2; }
.app-promo__cta{ margin-left:auto; }
@media (max-width:480px){ .app-promo{ padding:10px; } .app-promo__title{ font-size:14px; } }

/* ---------- Table card ---------- */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px}
table{width:100%;border-collapse:separate;border-spacing:0 10px;table-layout:fixed}
th,td{padding:12px;vertical-align:middle}
th{color:var(--ink-weak);text-align:center;border-bottom:1px solid var(--border)}
tr{background:var(--card);border:1px solid var(--border-strong);border-radius:12px}
tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
tbody tr{
  display:grid;
  grid-template-columns:var(--col-rank) minmax(0,1fr) var(--col-elev) var(--col-date) var(--col-done) var(--col-arrow);
  align-items:center;
}
td[data-cell="months"]{grid-column:4 / span 2;}
/* column widths */
/* Updated widths: column order = Rank, Mountain, Elevation, Date, Completed, Arrow */
thead th:nth-child(1), tbody td:nth-child(1){width:var(--col-rank)}
thead th:nth-child(2), tbody td:nth-child(2){width:auto}
thead th:nth-child(3), tbody td:nth-child(3){width:var(--col-elev)}
thead th:nth-child(4), tbody td:nth-child(4){width:var(--col-date)}
thead th:nth-child(5), tbody td:nth-child(5){width:var(--col-done)}
thead th:nth-child(6), tbody td:nth-child(6){width:var(--col-arrow)}
/* center Rank + Mountain + Elevation */
/* Center the first three columns (Rank, Mountain, Elevation) */
thead th:nth-child(-n+3), tbody td:nth-child(-n+3){text-align:center;vertical-align:middle}
.stat{text-align:center;font-variant-numeric:tabular-nums}
/* Mountain cell truly centered */
.cell-actions{display:flex;align-items:center;justify-content:center;gap:8px;height:100%;width:100%}

/* Free-floating photo block (decoupled from table cells) */
.row-photo{
  grid-column:1/-1;
  justify-self:center;
  width:290px;
  max-width:100%;
  margin:0 auto 8px;
  border-radius:12px;
  overflow:hidden;
  background:var(--panel);
  box-shadow:0 10px 28px rgba(0,0,0,0.35);
}
.row-photo img{
  display:block;
  width:100%;
  height:auto;
  aspect-ratio:5/3;
  object-fit:cover;
  background:var(--panel);
}

/* ---------- Date input (visible on iOS) ---------- */
input[type="date"]{
  appearance:none;-webkit-appearance:none;-moz-appearance:none;
  background:transparent;border:1px solid var(--border-strong);border-radius:999px;
  padding:8px 14px;font-size:14px;line-height:1;color:var(--ink);-webkit-text-fill-color:var(--ink);
  text-align:center;min-width:140px;position:relative;cursor:pointer;
}
input[type="date"]::-webkit-calendar-picker-indicator{opacity:0;width:1.6em;height:100%;position:absolute;right:8px;left:auto;top:0}

/* ---------- Icons ---------- */
.check{width:24px;height:24px;cursor:pointer}

/* ---------- Detail slide-in ---------- */
.detail-wrap{position:fixed;top:0;right:-480px;width:420px;height:100vh;background:var(--panel);border-left:1px solid var(--border);box-shadow:var(--shadow);transition:right .28s ease;z-index:9999;padding:16px;overflow:auto}
.detail-wrap.open{right:0}
.detail-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
.detail-title{font-size:18px;font-weight:700}
.detail-close{cursor:pointer;border:1px solid var(--border-strong);border-radius:8px;padding:6px 10px;background:transparent;color:var(--ink)}

/* Responsive override for detail panel on small screens */
@media (max-width:480px){
  .detail-wrap{width:100%; right:-100%;}
  .detail-wrap.open{right:0;}
}

/* ---------- Settings switches ---------- */
.settings{margin-top:16px;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--card)}
.settings h3{margin:0 0 8px 0;font-size:14px;color:var(--ink-weak)}
.settings .row{display:flex;align-items:center;justify-content:space-between;margin:8px 0}
.settings label{font-size:14px}
.switch{position:relative;display:inline-block;width:44px;height:24px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#888;transition:.2s;border-radius:999px}
.slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:#fff;transition:.2s;border-radius:50%}
input:checked + .slider{background:#4caf50}
input:checked + .slider:before{transform:translateX(20px)}

/* ---------- Modal (auth) ---------- */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:99999}
.modal.open{display:flex}
.sheet{width:min(520px,92vw);background:var(--panel);border:1px solid var(--border-strong);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
.sheet h2{margin:0 0 6px 0}
.field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
.field label{font-size:12px;color:var(--ink-weak)}
.field input{background:var(--input-bg);color:var(--ink);border:1px solid var(--border-strong);border-radius:10px;padding:10px}
.row-actions{display:flex;gap:10px;margin-top:14px;align-items:center}
.note{font-size:12px;color:var(--ink-weak)}
.err{color:#ff8080;font-size:12px}
.ok{color:var(--good);font-size:12px}

/* ---------- Row density + sticky header ---------- */
body.compact-rows table{border-spacing:0 6px}
body.compact-rows th,body.compact-rows td{padding:8px}
body.sticky-header thead th{position:sticky;top:0;background:var(--panel);z-index:2;box-shadow:0 1px 0 var(--border)}

/* ---------- Terms box in modal ---------- */
.tos-toggle{margin-top:12px;display:flex;align-items:center;gap:8px;font-size:13px;color:var(--ink-weak);cursor:pointer}
.tos-box{display:none;margin-top:8px;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;max-height:160px;overflow:auto;font-size:12px;color:var(--ink-weak)}
.tos-box.open{display:block}
.tos-agree{display:flex;align-items:center;gap:8px;margin-top:10px;font-size:13px}

/* ---------- Detail panel upgrades ---------- */
.detail-grid{display:grid;gap:12px;grid-template-columns:1fr;margin-top:8px}
.fact{border:1px solid var(--border);background:var(--card);border-radius:12px;padding:12px}
.fact h3{margin:0 0 8px 0;font-size:14px;color:var(--ink-weak)}
.kv{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:6px 0;border-top:1px dashed var(--border)}
.kv:first-of-type{border-top:none;padding-top:0}
.kv span{color:var(--ink-weak);font-size:13px}
.kv strong{font-size:14px}
.links-col{display:flex;flex-direction:column;gap:8px}
.btn-link{display:inline-flex;align-items:center;justify-content:center;min-height:36px;padding:8px 12px;border:1px solid var(--border-strong);border-radius:10px;background:transparent;color:var(--ink);text-decoration:none}
.btn-link:hover{background:var(--input-bg-hover)}
.small{font-size:12px}.xsmall{font-size:11px}

/* ---------- Grid Mode styles ---------- */
.month-strip { display:flex; gap:8px; overflow-x:auto; padding:6px 0; scroll-snap-type:x mandatory; }
.month-chip { flex:0 0 auto; scroll-snap-align:center; display:flex; align-items:center; justify-content:center; min-width:54px; height:32px; border-radius:999px; border:1px solid var(--border); background:var(--chip-bg); color:var(--ink); font-size:12px; cursor:pointer; padding:0 10px; user-select:none; }
.month-chip.done { border-color:var(--good); box-shadow:0 0 0 1px var(--good) inset; }
.month-chip .dot { width:6px; height:6px; border-radius:50%; background:var(--good); margin-left:6px; }
.month-picker { display:none; margin-top:8px; text-align:center; }
.month-picker.open { display:block; }
.grid-hint { color:var(--ink-weak); font-size:12px; margin:6px 0 -2px; }

/* ---------- Accessibility ---------- */
:focus-visible{outline:2px solid var(--accent);outline-offset:2px}

/* ---------- Print ---------- */
@media print{
  .topbar,.sidebar,.detail-wrap,#pbReset{display:none!important}
  .content{grid-template-columns:1fr;padding:0}
  body{background:#fff;color:#000}
  .panel{border:none;box-shadow:none;padding:0}
  table{border-spacing:0}
  tr{border:1px solid #000!important}
  th,td{color:#000!important}
}

/* ---------- Reduced motion ---------- */
@media (prefers-reduced-motion:reduce){.detail-wrap{transition:none}}

/*
 * iOS mobile scroll fix
 *
 * Safari on iOS can exhibit erratic scrolling behaviour when an iframe is embedded
 * within another page. In particular, the first scroll gesture after touching
 * inside the iframe often fails to start a scroll, requiring the user to
 * initiate the gesture from outside the iframe instead. Forcing hardware
 * acceleration on the page helps Safari establish a new compositing layer for
 * the document, which stabilizes touch-driven scrolling within the iframe.
 * Applying translate3d with zero offsets triggers hardware acceleration without
 * visually moving the document. See: https://davidwalsh.name/scroll-iframes-ios
 */
html, body {
  -webkit-transform: translate3d(0, 0, 0);
}

/* ---------- Guardrail: no sideways scroll on small viewports ---------- */
@media (max-width:1024px){html,body,.app,.content,.panel{max-width:100%;overflow-x:hidden}}

/* ---------- Tablet & down ---------- */
@media (max-width:880px){
  .content{grid-template-columns:1fr}
  .progress-head{flex-wrap:wrap;gap:8px 12px}
  .list-title{font-size:20px;order:2;width:100%}
  :root{--ctrl-h:36px}
  .controls{grid-template-columns:1fr 1fr 1fr;gap:10px}
  .controls .ctrl input[type="search"]{height:calc(var(--ctrl-h) - 2px)}
  table{border-spacing:0 14px}
  th,td{padding:10px}
  input[type="date"]{min-width:120px}
}

/* ---------- Phone layout: Complete rebuild using flexbox cards ---------- */
@media (max-width:700px){
  table thead{display:none}
  table{border-spacing:0;border-collapse:collapse}
  tbody{display:flex;flex-direction:column;gap:16px;padding:16px 12px}
  
  tbody tr{
    display:flex;
    flex-direction:column;
    background:var(--card);
    border:1px solid var(--border-strong);
    border-radius:12px;
    overflow:hidden;
    max-width:100%;
    width:100%;
  }

  /* Image - full width, no padding */
  td[data-cell="pic"]{
    width:100%;
    height:200px;
    padding:0 !important;
    margin:0 !important;
    border:none !important;
    background:var(--panel);
    display:block !important;
  }

  td[data-cell="pic"] img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }

  /* Peak name - prominent heading */
  td[data-cell="name"]{
    padding:16px 16px 12px !important;
    border:none !important;
    background:transparent !important;
    display:block !important;
    font-size:22px;
    font-weight:700;
    color:var(--ink);
    text-align:left;
    margin:0 !important;
  }

  /* Data cells - stacked layout */
  td[data-cell="rank"],
  td[data-cell="elev"],
  td[data-cell="date"],
  td[data-cell="done"]{
    padding:8px 16px !important;
    border:none !important;
    background:transparent !important;
    display:block !important;
    margin:0 !important;
  }

  /* Last cell gets bottom padding */
  td[data-cell="done"]{
    padding:8px 16px 16px !important;
  }

  /* Label + value stacking */
  td[data-cell="rank"]::before,
  td[data-cell="elev"]::before,
  td[data-cell="date"]::before,
  td[data-cell="done"]::before{
    content:var(--label);
    display:block;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:0.4px;
    color:var(--ink-weak);
    margin-bottom:4px;
  }

  td[data-cell="rank"]{--label:"Rank";}
  td[data-cell="elev"]{--label:"Elevation";}
  td[data-cell="date"]{--label:"Date";}
  td[data-cell="done"]{--label:"Completed";}

  /* Value styling */
  td[data-cell="rank"] .cell-value,
  td[data-cell="elev"] .cell-value{
    font-size:16px;
    font-weight:600;
    color:var(--ink);
  }

  input[type="date"]{
    width:100%;
    padding:10px 12px;
    font-size:14px;
    background:var(--input-bg);
    border:1px solid var(--border-strong);
    border-radius:8px;
    color:var(--ink);
  }

  .check{
    width:24px;
    height:24px;
    cursor:pointer;
  }

  th{display:none}
  td{padding:0}
  td[data-cell="open"]{display:none}

  .controls{grid-template-columns:1fr 1fr;gap:10px}
  .controls .ctrl{grid-column:1 / -1}
}

/* ---------- Smaller phones (480px) ---------- */
@media (max-width:480px){
  tbody{padding:12px 8px}
  tbody tr{max-width:100%}
  
  td[data-cell="pic"]{height:180px}
  
  td[data-cell="name"]{
    padding:14px 14px 10px !important;
    font-size:18px;
  }

  td[data-cell="rank"],
  td[data-cell="elev"],
  td[data-cell="date"],
  td[data-cell="done"]{
    padding:6px 14px !important;
  }

  td[data-cell="done"]{
    padding:6px 14px 14px !important;
  }

  td[data-cell="rank"]::before,
  td[data-cell="elev"]::before,
  td[data-cell="date"]::before,
  td[data-cell="done"]::before{
    font-size:10px;
    margin-bottom:3px;
  }
}

/* ---------- Very small phones (380px) ---------- */
@media (max-width:380px){
  tbody{padding:10px 6px;gap:12px}
  
  td[data-cell="pic"]{height:160px}
  
  td[data-cell="name"]{
    padding:12px 12px 8px !important;
    font-size:16px;
  }

  td[data-cell="rank"],
  td[data-cell="elev"],
  td[data-cell="date"],
  td[data-cell="done"]{
    padding:5px 12px !important;
  }

  td[data-cell="done"]{
    padding:5px 12px 12px !important;
  }
}

/* Explicit 320px hard stop override */
@media (max-width:320px){
  tbody{padding:8px 4px;gap:10px}
  tbody tr{border-radius:10px}
  
  td[data-cell="pic"]{height:140px}
  
  td[data-cell="name"]{
    padding:10px 10px 6px !important;
    font-size:14px;
  }

  td[data-cell="rank"],
  td[data-cell="elev"],
  td[data-cell="date"],
  td[data-cell="done"]{
    padding:4px 10px !important;
    font-size:13px;
  }

  td[data-cell="done"]{
    padding:4px 10px 10px !important;
  }

  input[type="date"]{
    padding:8px 10px;
    font-size:12px;
  }

  .check{width:20px;height:20px}
}

    </style>
    <!-- Collapsible and mobile pager styles (NEW) -->
    <style>
/* Collapsible sections (Settings and Resources) */
.collapsible-section summary {
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  color: var(--ink);
  padding: 8px 0;
}
.collapsible-section summary::-webkit-details-marker {
  display: none;
}
.collapsible-section > .settings,
.collapsible-section > .panel {
  margin-top: 8px;
}
/* Mobile pager layout: controls above text and centered */
@media (max-width:700px){
  .pager-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    /* reduce vertical spacing on mobile */
    margin: 8px 0;
    padding: 4px 0;
  }
  .pager-wrap .pager-stats {
    order: 2;
    text-align: center;
  }
  .pager-wrap .page-list {
    order: 1;
    justify-content: center;
  }
}
    </style>

    <!-- Custom visual overrides appended to fix design issues -->
    <style id="peakbagger-visual-overrides">
/* =========================================
   VISUAL REFINEMENT OVERRIDES (non-breaking)
   - Wider/cleaner sidebar
   - Stronger table contrast + zebra rows
   - Better date-input legibility
   - Row hover, sticky controls
   - Responsive tweaks to avoid truncation
========================================== */

/* --- Layout polish --- */
.content{
  /* widen the sidebar so labels don‚Äôt truncate */
  grid-template-columns: 360px 1fr;
}
@media (max-width: 960px){
  .content{ grid-template-columns: 1fr; }
}

/* Make top controls bar stay visible while scrolling list */
.topbar{
  position: sticky;
  top: 0;
  z-index: 40;
  box-shadow: 0 2px 0 var(--border);
}

/* Sidebar: avoid cramped items & truncation */
.sidebar{ line-height: 1.25; }
.links-col .btn-link{
  justify-content: flex-start;
  white-space: normal;         /* allow wrapping, not ellipsis */
  text-align: left;
}
.links-col .btn-link:focus-visible{
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

/* Brand/title breathing room on small screens */
.brand h1{ font-size: 18px; }
@media (max-width: 480px){
  .brand h1{ font-size: 16px; }
}

/* --- Table readability --- */

/* Headings a bit stronger + centered labels already in base */
th{ font-size: 13px; letter-spacing:.2px; }

/* Higher contrast row styling + zebra striping */
tbody tr{
  background: var(--card);
  transition: border-color .15s ease, box-shadow .15s ease, transform .02s ease;
}
tbody tr:hover{
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent) inset;
}
tbody tr:nth-child(odd){
  /* alternate shade for scanning */
  background: color-mix(in oklab, var(--card) 85%, black);
}
.theme-light tbody tr:nth-child(odd){
  background: color-mix(in oklab, var(--card) 90%, #e9eefc);
}

/* Make the ‚ÄòMountain‚Äô cell truly centered & never feel off */
tbody td[data-cell="name"]{
  font-weight: 600;
  text-wrap: balance;
}

/* Column separators are subtle but help column scanning */
tbody td + td{
  border-left: 1px dashed var(--border);
}
@media (max-width: 700px){
  /* grid layout on phones already hides the separators */
  tbody td + td{ border-left: none; }
}

/* --- Inputs (date) legibility --- */
input[type="date"]{
  background: var(--input-bg);        /* instead of transparent */
  -webkit-text-fill-color: var(--ink);
  color: var(--ink);
  border: 1px solid var(--border);
  box-shadow: none;
}
input[type="date"]:hover{ background: var(--input-bg-hover); }
input[type="date"]:focus{
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(156,200,255,.16);
}

/* Tighten date token on narrow screens */
@media (max-width: 700px){
  input[type="date"]{ font-size: 13px; }
}

/* --- Checkmark hit-area --- */
.check{
  width: 26px; height: 26px;
  filter: drop-shadow(0 0 0 rgba(0,0,0,0));
  transition: transform .05s ease;
}
.check:active{ transform: scale(.96); }

/* --- Sticky table header is user-togglable; when on, make it pop --- */
body.sticky-header thead th{
  background: var(--panel);
  box-shadow: 0 1px 0 var(--border), 0 8px 16px rgba(0,0,0,.05);
}

/* --- Density: compact mode gets slightly smaller type for cells --- */
body.compact-rows td, body.compact-rows th{ font-size: 13px; }

/* --- Mobile: prevent side scroll & keep chips/controls airy --- */
@media (max-width: 700px){
  .controls{ gap: 12px; }
  .controls .ctrl, .controls .ctrl-btn{ min-height: 40px; }
  .month-strip{ padding: 4px 0; }
  .month-chip{ min-width: 52px; height: 30px; }
}

/* --- Light theme fine-tunes --- */
.theme-light tbody tr:hover{
  box-shadow: 0 0 0 1px var(--accent) inset, 0 1px 0 rgba(0,0,0,.04);
}
.theme-light input[type="date"]{
  border-color: var(--border);
}
    </style>

    <!-- Pager styles (NEW) -->
    <style>
/* ==== Peakbagger pager (matches plant catalog look) ==== */
.pager-wrap{
  display:grid;
  grid-template-columns:auto 1fr;
  align-items:center;
  gap:10px;
  margin:16px 0;
  padding:6px 0;
}
.pager-stats{
  color:var(--ink-weak);
  font-size:12px;
  white-space:nowrap;
}
.page-list{
  display:flex;
  gap:6px;
  flex-wrap:nowrap;
  justify-content:center;
}
/* Base page button styling */
.page-btn{
  background:var(--card);
  border:1px solid var(--border-strong);
  border-radius:10px;
  min-width:34px;
  height:34px;
  display:grid;
  place-items:center;
  cursor:pointer;
  color:var(--ink);
}
.page-btn[disabled]{ opacity:.5; cursor:not-allowed; }
.page-btn[aria-current="page"]{
  border-color:var(--accent);
  outline:2px solid #22c55e55;
  color:#ffffff;
}
@media (max-width:480px){
  .pager-wrap{ margin:14px 0; padding:4px 0; }
  .pager-stats{ font-size:11px; }
  .page-list{ gap:4px; }
  .page-btn{ min-width:26px; height:26px; font-size:12px; border-radius:8px; }
}
    </style>

    <!-- Collapsible and mobile pager styles (NEW) -->
    <style>
    /* Styles for collapsible sections and mobile pager layout */
    details.collapsible-section {
      margin-top:14px;
    }
    .collapsible-section summary {
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      margin-bottom:6px;
      color:var(--ink-weak);
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .collapsible-section summary::-webkit-details-marker {
      display:none;
    }
    .collapsible-section[open] summary {
      margin-bottom:8px;
    }
    @media (max-width:960px) {
      /* Hide settings/resources headings on larger screens */
      .sidebar details.collapsible-section {
        /* nothing here intentionally */
      }
    }
    /* Mobile pager stacking: page controls above stats and centered */
    @media (max-width:700px) {
      .pager-wrap {
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        gap:4px;
      }
      .pager-wrap .page-list {
        order:1;
        justify-content:center;
      }
      .pager-wrap .pager-stats {
        order:2;
        text-align:center;
      }
    }
    </style>

<!-- Additional styles for NH48 API integration -->
    <style>
    /* Profile image for each mountain in list */
    .profile-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
      flex-shrink: 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.35);
      border: 1px solid color-mix(in oklab, var(--border) 60%, black);
    }
    /* Photos carousel in detail panel */
    #detailPhotos {
      margin-bottom: 16px;
    }
    .carousel {
      position: relative;
    }
    .carousel img {
      width: 100%;
      height: auto;
      object-fit: cover;
      border-radius: 8px;
    }
    .carousel-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-top: 8px;
    }
    .carousel-controls button {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--ink);
      cursor: pointer;
    }
    .carousel-controls span {
      color: var(--ink-weak);
    }
    /* Carousel thumbnails & indicators */
    .carousel-wrap { display:flex; flex-direction:column; gap:8px; }
    .carousel-main {
      position: relative;
      width: 100%;
      /* Enforce a square aspect ratio for the main photo to avoid overly tall images */
      aspect-ratio: 1 / 1;
      overflow: hidden;
    }
    /* Ensure the main image fills its square container and crops as needed */
    .carousel-main img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .carousel-prev, .carousel-next {
      position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.35); color:#fff; border:none; padding:6px 8px; border-radius:6px; cursor:pointer;
    }
    .carousel-prev{ left:8px }
    .carousel-next{ right:8px }
    .carousel-thumbs{ display:flex; gap:8px; overflow-x:auto; padding-top:6px }
    .carousel-thumb{ width:64px; height:44px; flex:0 0 auto; border-radius:6px; object-fit:cover; cursor:pointer; opacity:.8; border:1px solid var(--border); }
    .carousel-thumb.active{ outline:2px solid var(--accent); opacity:1 }
    .carousel-indicators{ display:flex; gap:6px; justify-content:center; margin-top:6px }
    .carousel-indicators .dot{ width:8px; height:8px; border-radius:50%; background:var(--input-bg); border:1px solid var(--border); }
    .carousel-indicators .dot.active{ background:var(--accent); }

    /* Hover preview for list profile images */
    .img-preview {
      position:fixed; z-index:999999; pointer-events:none; border-radius:8px; overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,.45); border:1px solid var(--border-strong); background:var(--panel);
      width:260px; max-width:40vw; transform:translateY(-6px);
    }
    .img-preview img{ width:100%; height:auto; display:block }
    /* App version badge */
    .app-version {
      position: fixed;
      right: 10px;
      bottom: 8px;
      z-index: 999999;
      font-size: 12px;
      color: var(--ink-weak);
      background: transparent;
      padding: 6px 8px;
      border-radius: 8px;
      pointer-events: none;
      opacity: 0.9;
    }
    </style>

    <!-- UI improvements and mobile card view -->
    <style>
    /* Allow page to scroll instead of nested scrollbars */
    .app { overflow: visible; }

    /* Reinforce the mobile grid with full-width images and clear spacing */
    @media (max-width: 700px) {
      table tbody td:nth-child(1) { padding: 0; }
      table tbody td:nth-child(1) img.profile-img {
        width: 100%;
        aspect-ratio: 5/3;
        object-fit: cover;
        border-radius: 12px;
        display: block;
      }

      td[data-cell="name"] { text-align: left; }
      td[data-cell="date"] input[type="date"] {
        width: 100%;
        margin-inline: 0;
      }

      /* Strip any residual separators from earlier styles */
      table tbody td { border-top: none !important; }
    }

    /* Completed row styling: change border and mountain name color when a peak is completed */
    .completed {
      border: 2px solid var(--good);
    }
    .completed .mountain-link {
      color: var(--good);
    }
    </style>

<!-- Responsive Adjustments: allow panels to shrink and pager wrap on tiny screens -->
    <style>
    /* Let the panels shrink: remove default min-width on sidebar and panel */
    .content > * {
      min-width: 0;
    }
    .sidebar,
    .panel {
      min-width: 0;
    }
    /* Allow pager stats to wrap on very narrow screens */
    @media (max-width:340px){
      .pager-stats{
        white-space: normal;
      }
    }
    /* Reduce date input minimum widths on tiny screens */
    @media (max-width:320px){
      input[type="date"]{
        min-width: 0;
        width: 100%;
        max-width: 150px;
      }
    }
    </style>

    <!-- Consolidated CSS for pager, collapsible sections, and very narrow screens -->
    <style id="consolidated-css">
    /* Consolidated pager base styles */
    .pager-wrap {
      display: grid;
      grid-template-columns: auto 1fr;
      align-items: center;
      gap: 10px;
      margin: 16px 0;
      padding: 6px 0;
    }
    .pager-stats {
      color: var(--ink-weak);
      font-size: 12px;
      white-space: nowrap;
    }
    .page-list {
      display: flex;
      gap: 6px;
      flex-wrap: nowrap;
      justify-content: center;
    }
    .page-btn {
      background: var(--card);
      border: 1px solid var(--border-strong);
      border-radius: 10px;
      min-width: 34px;
      height: 34px;
      display: grid;
      place-items: center;
      cursor: pointer;
      color: var(--ink);
    }
    .page-btn[disabled] {
      opacity: .5;
      cursor: not-allowed;
    }
    .page-btn[aria-current="page"] {
      border-color: var(--accent);
      outline: 2px solid #22c55e55;
      color: #ffffff;
    }
    /* Mobile pager stacking */
    @media (max-width:700px) {
      .pager-wrap {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        margin: 8px 0;
        padding: 4px 0;
      }
      .pager-wrap .page-list {
        order: 1;
        justify-content: center;
      }
      .pager-wrap .pager-stats {
        order: 2;
        text-align: center;
      }
    }
    /* Fine-tune pager controls on small devices */
    @media (max-width:480px) {
      .pager-wrap {
        margin: 14px 0;
        padding: 4px 0;
      }
      .pager-stats {
        font-size: 11px;
      }
      .page-list {
        gap: 4px;
      }
      .page-btn {
        min-width: 26px;
        height: 26px;
        font-size: 12px;
        border-radius: 8px;
      }
    }
    /* Consolidated collapsible section styles */
    .collapsible-section summary {
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      color: var(--ink-weak);
      margin-bottom: 6px;
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .collapsible-section summary::-webkit-details-marker {
      display: none;
    }
    .collapsible-section[open] summary {
      margin-bottom: 8px;
    }
    /* Consolidated ultra-narrow screen adjustments (<=360px) */
    @media (max-width:360px) {
      /* Wrap pager stats text to avoid overflow */
      .pager-stats {
        white-space: normal;
      }
      /* Compact row and column sizes */
      :root {
        --gut: clamp(0px, 1vw, 2px);
        --row-px: clamp(4px, 2vw, 6px);
        --row-py: clamp(4px, 2vw, 6px);
        --col-rank: clamp(32px, 10vw, 36px);
        --col-elev: clamp(64px, 22vw, 70px);
      }
      tbody tr {
        gap: clamp(4px, 2vw, 6px) clamp(6px, 3vw, 8px);
        padding: var(--row-py) var(--row-px);
        margin: clamp(4px, 1.5vw, 6px) auto;
        width: calc(100% - var(--gut) * 2);
        border-radius: 10px;
      }
      /* Narrow date inputs further and center them */
      input[type="date"] {
        min-width: clamp(116px, 40vw, 124px);
        max-width: clamp(160px, 55vw, 172px);
        font-size: 12px;
        padding: 6px 8px;
        text-align: center;
      }
      /* Shrink checkmark hit area on very small screens */
      .check {
        width: 22px;
        height: 22px;
        margin: 0 auto;
        transform: translateX(clamp(-30px, -4.2vw, -30px));
      }
      /* Hide completed column on ultra-narrow screens */
      thead th:nth-child(6),
      tbody td:nth-child(6) {
        display: none !important;
      }
    }
    </style>

    <!-- Mobile overrides: remove dotted separators and support 280px viewports -->
    <style>
    /* Remove dotted/dashed separators on mobile cards */
    @media (max-width: 700px) {
      table tbody td:nth-child(2),
      table tbody td:nth-child(3),
      table tbody td:nth-child(4),
      table tbody td:nth-child(5),
      table tbody td:nth-child(6) {
        border-top: none !important;
      }
    }

    /* Responsive tuning for very small screens (<= 280px) */
    @media (max-width: 280px) {
      :root {
        --gut: clamp(0px, 1vw, 2px);
        --row-px: clamp(2px, 1vw, 4px);
        --row-py: clamp(2px, 1vw, 4px);
        --col-rank: clamp(28px, 10vw, 34px);
        --col-elev: clamp(56px, 24vw, 64px);
      }
      tbody tr {
        gap: clamp(2px, 1.5vw, 4px) clamp(4px, 2vw, 6px);
        padding: var(--row-py) var(--row-px);
        margin: clamp(2px, 1vw, 4px) auto;
        width: calc(100% - var(--gut) * 2);
        border-radius: 8px;
      }
      td[data-cell="date"] input[type="date"] {
        min-width: clamp(100px, 40vw, 110px);
        max-width: clamp(140px, 60vw, 150px);
        font-size: 11px;
        padding: 4px 6px;
        text-align: center;
      }
      .check {
        width: 20px;
        height: 20px;
        transform: translateX(clamp(-20px, -5vw, -20px));
      }
      /* Hide the completed column on extremely narrow screens */
      thead th:nth-child(6),
      tbody td:nth-child(6) {
        display: none !important;
      }
    }
    </style>

    </head>
<body>
<div class="app">
  <div class="topbar">
    <div class="row1">
      <div class="progress-wrap">
        <div class="progress-head">
          <span id="unitToggle" class="ctrl-btn" title="Toggle units"><span class="ico">‚öôÔ∏è</span><span id="unitLabel">Feet (ft)</span></span>

          <!-- NEW: centered list title -->
          <div id="listTitle" class="list-title">‚Äî</div>

          <span id="progressText" class="subtle">0/0 ‚Ä¢ 0%</span>
        </div>
        <div class="progress" aria-label="progress"><div class="bar" id="bar"></div></div>
      </div>
      <div class="controls">
        <div class="ctrl"><span class="ico">üîé</span><input id="search" type="search" placeholder="Search peaks‚Ä¶" /></div>
        <div class="ctrl-btn" id="sortBtn" title="Toggle sort"><span class="ico">‚öôÔ∏è</span> <span>Sort: <strong id="sortLabel">Rank</strong></span></div>
        <div class="ctrl-btn" id="showComplete"><span class="ico">‚óØ</span> <span>Hide completed</span></div>
        <!-- NEW: Mode toggle (Checklist / Grid) -->
        <div class="ctrl-btn" id="modeBtn" title="Switch between checklist and grid"><span class="ico">üîÅ</span> <span>Mode: <strong id="modeLabel">Checklist</strong></span></div>
        <div class="ctrl-btn" id="exportBtn"><span class="ico">üóÑÔ∏è</span> <span>Export XLSX</span></div>
      </div>
    </div>
  </div>

  <div class="content">
    <aside class="sidebar">
      <div class="brand">
        <img src="https://static.wixstatic.com/media/66b1b2_6dfce097ed584b5296afeb83f26e4c8a~mv2.png" alt="logo" style="width:32px;height:32px;border-radius:8px;border:1px solid var(--border-strong)" loading="lazy" />
        <div>
          <h1 style="margin:0">Peakbagger (Web)</h1>
          <div class="subtle">Private to this embed</div>
        </div>
      </div>

      <a class="app-promo" href="https://apps.apple.com/us/app/peakbaggers-journal/idXXXXXXXXX" target="_blank" rel="noopener">
        <img class="app-promo__icon" src="https://static.wixstatic.com/media/66b1b2_6dfce097ed584b5296afeb83f26e4c8a~mv2.png" alt="Peakbagger‚Äôs Journal iOS icon" loading="lazy">
        <div class="app-promo__meta">
          <div class="app-promo__title">Peakbagger‚Äôs Journal (iOS)</div>
          <div class="app-promo__sub">Available on the App Store</div>
        </div>
        <span class="btn btn-primary btn-small app-promo__cta">View</span>
      </a>

      <div class="auth" id="authCard">
        <div id="authSignedOut">
          <div class="row">
            <div>
              <div class="subtle">You‚Äôre not signed in</div>
              <div style="font-size:13px;color:var(--ink)">Sign in to save your progress</div>
            </div>
            <button class="btn btn-primary btn-small" id="openAuth">Sign in</button>
          </div>
        </div>
        <div id="authSignedIn" style="display:none">
          <div class="row" style="align-items:flex-start">
            <div>
              <div class="subtle">Signed in</div>
              <div id="meName" style="font-weight:600;margin-top:2px"></div>
              <div id="meEmail" class="subtle"></div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
              <button class="btn btn-ghost btn-small" id="logoutBtn">Sign out</button>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:14px">
        <label for="listSelect" class="subtle" style="font-size:14px">Choose List:</label>
        <select id="listSelect" class="select" style="width:100%;margin-top:6px"></select>
      </div>

      <details id="settingsDetails" class="collapsible-section"><summary>Settings</summary><div class="settings">
        <div class="row">
          <label>Units: meters</label>
          <label class="switch"><input id="metersToggle" type="checkbox"><span class="slider"></span></label>
        </div>
        <!-- Theme is now managed via the Themes dropdown in the sidebar -->

        <!-- NEW: Row density -->
        <div class="row">
          <label>Row density: <strong id="densityLabel">Comfortable</strong></label>
          <label class="switch"><input id="densityToggle" type="checkbox"><span class="slider"></span></label>
        </div>
        <!-- NEW: Sticky header -->
        <div class="row">
          <label>Sticky header</label>
          <label class="switch"><input id="stickyToggle" type="checkbox"><span class="slider"></span></label>
        </div>
      </div></details>

      <!-- Themes dropdown (pre-collapsed) -->
      <details id="themeDetails" class="collapsible-section"><summary>Themes</summary>
        <div class="panel" style="margin-top:8px">
          <label for="themeSelect" class="subtle">Choose theme</label>
          <select id="themeSelect" class="select" style="width:100%;margin-top:6px">
            <option value="dark">Dark (default)</option>
            <option value="light">Light (white & black)</option>
            <option value="forest">Forest Green</option>
            <option value="sky">Sky Blue</option>
          </select>
        </div>
      </details>

      <!-- NEW: Resources panel -->
      <details id="resourcesDetails" class="collapsible-section"><summary>Resources</summary><div class="panel" style="margin-top:14px">
        <div class="links-col">
          <a class="btn-link" href="https://trailsnh.com/" target="_blank" rel="noopener">TrailsNH (trip reports)</a>
          <a class="btn-link" href="https://www.weather.gov/" target="_blank" rel="noopener">NOAA Weather</a>
          <a class="btn-link" href="https://www.peakbagger.com/" target="_blank" rel="noopener">Peakbagger (lists & facts)</a>
          <a class="btn-link" href="https://www.mountwashington.org/" target="_blank" rel="noopener">Mount Washington Observatory</a>
          <a class="btn-link" href="https://www.fs.usda.gov/whitemountain" target="_blank" rel="noopener">WMNF Alerts/Notices</a>
        </div>
        <p class="subtle xsmall" style="margin-top:8px">External links open in a new tab.</p>
        </div></details>

      <!-- NEW: Copyright -->
      <div class="copyright">¬© <span id="copyrightYear"></span> Nathan Sobol</div>
    </aside>

    <main class="panel">
      <!-- Pagination header (Top) -->
      <div class="pager-wrap">
        <div class="pager-stats" id="pg-stats-top">Showing ‚Äî</div>
        <div class="page-list"  id="pg-list-top"  aria-label="Pagination (top)"></div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:64px">Rank</th>
            <th>Mountain</th>
            <th style="width:140px">Elevation</th>
            <th style="width:160px">Date / Months</th>
            <th style="width:120px">Completed</th>
            <th style="width:48px"></th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <!-- Pagination footer (Bottom) -->
      <div class="pager-wrap">
        <div class="pager-stats" id="pg-stats-bot">Showing ‚Äî</div>
        <div class="page-list"  id="pg-list-bot"  aria-label="Pagination (bottom)"></div>
      </div>
    </main>
  </div>
</div>

<!-- Detail Slide-in (REPLACED/EXPANDED) -->
<div class="detail-wrap" id="detail" aria-live="polite">
  <div class="detail-head">
    <div class="detail-title" id="detailTitle">‚Äî</div>
    <button class="detail-close" id="detailClose" aria-label="Close details">Close</button>
  </div>

  <p class="subtle" id="detailSub" style="margin:6px 0 12px">
    Quick facts, weather & helpful links. (Your progress stays private on this device.)
  </p>

  <!-- NEW: Photos for detail -->
  <div id="detailPhotos"></div>

  <div class="detail-grid">
    <!-- Fast facts -->
    <section class="fact">
      <h3>Fast facts</h3>
      <div class="kv"><span>Elevation</span><strong id="detailElev">‚Äî</strong></div>
      <!-- Replace strong with editable date input -->
      <div class="kv"><span>Date completed</span><input type="date" id="detailDateInput" class="date-input" value="" /></div>
      <div class="kv"><span>Location</span><strong id="detailLocation" data-empty="‚Äî">‚Äî</strong></div>
      <div class="kv"><span>Prominence</span><strong id="detailProm" data-empty="‚Äî">‚Äî</strong></div>
      <div class="kv"><span>Difficulty</span><strong id="detailDiff" data-empty="‚Äî">‚Äî</strong></div>
    </section>

    <!-- Weather (link-first, embed later if desired) -->
    <section class="fact">
      <h3>Weather</h3>
      <p class="subtle small">
        Forecast links open in a new tab. NOAA point forecasts work best near the summit.
      </p>
      <div class="links-col">
        <a class="btn-link" id="wxNoaa" href="https://www.weather.gov/" target="_blank" rel="noopener">NOAA Point Forecast</a>
        <a class="btn-link" id="wxOpenMeteo" href="https://open-meteo.com/en/docs" target="_blank" rel="noopener">Open-Meteo (lat/lon)
        </a>
        <a class="btn-link" id="wxTrailsNH" href="https://trailsnh.com/" target="_blank" rel="noopener">TrailsNH Summit Forecast</a>
        <a class="btn-link" id="wxMWOBS" href="https://www.mountwashington.org/experience-the-weather/" target="_blank" rel="noopener">MWOBS (Presidentials)</a>
      </div>
    </section>

    <!-- Helpful links (search-first, API later) -->
    <section class="fact">
      <h3>Learn more</h3>
      <div class="links-col">
        <a class="btn-link" id="lnkWikipedia" href="https://en.wikipedia.org/wiki/Special:Search?search=White+Mountains+NH+peak" target="_blank" rel="noopener">Wikipedia</a>
        <a class="btn-link" id="lnkPeakbagger" href="https://www.peakbagger.com/" target="_blank" rel="noopener">Peakbagger</a>
        <a class="btn-link" id="lnkAllTrails" href="https://www.alltrails.com/search?q=White+Mountains+NH" target="_blank" rel="noopener">AllTrails</a>
        <a class="btn-link" id="lnkSummitPost" href="https://www.summitpost.org/object_list.php?object_type=1&orderby=objectname%20ASC&object_name=New%20Hampshire" target="_blank" rel="noopener">SummitPost</a>
        <a class="btn-link" id="lnkMaps" href="https://www.openstreetmap.org/" target="_blank" rel="noopener">OpenStreetMap</a>
      </div>
      <p class="subtle xsmall" style="margin-top:8px">
        These links are generic for now; they‚Äôll auto-target this mountain when dynamic data is enabled.
      </p>
    </section>
  </div>
</div>

<!-- Auth Modal -->
<div class="modal" id="authModal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <h2 id="authTitle">Sign in</h2>
    <div class="subtle" id="authSubtitle">Use email and password just for this web app.</div>

    <div class="field"><label for="authName">Name (for new accounts)</label><input id="authName" type="text" placeholder="Your name" autocomplete="name"></div>
    <div class="field"><label for="authEmail">Email</label><input id="authEmail" type="email" placeholder="you@email.com" autocomplete="email"></div>
    <div class="field"><label for="authPass">Password</label><input id="authPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>

    <!-- NEW: Terms & Conditions -->
    <div class="tos-toggle" id="tosToggle">üìÑ View Terms & Conditions</div>
    <div class="tos-box" id="tosBox">
      <div id="tosText"></div>
    </div>
    <label class="tos-agree">
      <input type="checkbox" id="tosAgree" />
      <span>I agree to the Terms & Conditions</span>
    </label>

    <div class="row-actions">
      <button class="btn btn-primary" id="doSignin">Sign in</button>
      <button class="btn btn-ghost" id="doSignup" disabled>Create account</button>
      <span class="space"></span>
      <button class="btn btn-ghost" id="closeAuth">Close</button>
    </div>
    <div id="authMsg" class="note" style="margin-top:8px"></div>
  </div>
</div>

<!-- XLSX lib -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- Settings labels sync (capitalized) -->
<script>
document.addEventListener('DOMContentLoaded',()=>{
  const metersToggle=document.getElementById('metersToggle');
  const themeSelect = document.getElementById('themeSelect');
  const metersLabel=metersToggle.closest('.row').querySelector('label');
  const updMeters=()=>{metersLabel.textContent='Units: '+(metersToggle.checked?'Meters':'Feet')};
  updMeters();
  metersToggle.addEventListener('change',updMeters);
  // sync theme select default from prefs if present
  try{ const prefs = JSON.parse(localStorage.getItem('pb_prefs_v1')||'{}'); if (themeSelect && prefs.theme) themeSelect.value = prefs.theme; }catch(e){}
});
</script>

<!-- App -->
<script type="module">
// NH48 API integration constants and helpers
// Location of the NH48 API dataset. When running from the local filesystem
// (file protocol), point to the bundled nh48.json in the repo so that
// CORS is not an issue. Otherwise fall back to the CDN URL.
// Relative path to the bundled NH48 dataset. When served over HTTP (e.g. GitHub Pages),
// this will be fetched from the same origin without CORS issues. When viewing via
// file:// protocol, fetching may fail but the application will still function when
// hosted online.
// Use the NH48 data from the API repo.
// rawcdn.githack.com serves GitHub files with proper CORS headers, so fetch() will succeed.
const NH48_API_URL = 'https://rawcdn.githack.com/natesobol/nh48-api/main/data/nh48.json';

let NH48_DATA = null;
let NH48_SLUG_MAP = {};

async function fetchNh48Data() {
  if (NH48_DATA) return NH48_DATA;
  try {
    const resp = await fetch(NH48_API_URL, { mode: 'cors' });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    NH48_DATA = await resp.json();
    buildSlugMap();
  } catch (e) {
    console.error('Failed to load NH48 data', e);
    NH48_DATA = {};
  }
  return NH48_DATA;
}

function slugify(name) {
  return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
}

// Build a lookup map from various name variants to slug. This helps match peaks whose
// list names omit "Mount" or "Mountain" prefixes/suffixes, such as "Washington" ("Mount Washington").
function buildSlugMap() {
  NH48_SLUG_MAP = {};
  if (!NH48_DATA) return;
  Object.entries(NH48_DATA).forEach(([slug, entry]) => {
    const names = [];
    if (entry.peakName) names.push(entry.peakName);
    if (entry['Peak Name']) names.push(entry['Peak Name']);
    names.forEach(n => {
      const key = (n || '').toLowerCase().trim();
      if (!key) return;
      NH48_SLUG_MAP[key] = slug;
      // If the name starts with "mount ", map without that prefix too
      if (key.startsWith('mount ')) {
        const base = key.replace(/^mount\s+/, '').trim();
        NH48_SLUG_MAP[base] = slug;
      }
      // If the name ends with " mountain", map without that suffix too
      if (key.endsWith(' mountain')) {
        const base2 = key.replace(/\s*mountain$/, '').trim();
        NH48_SLUG_MAP[base2] = slug;
      }
    });
  });
}

// Determine slug for a peak name by using the precomputed map; fallback to naive slugify.
function getSlugForName(name) {
  const key = (name || '').toLowerCase().trim();
  return NH48_SLUG_MAP[key] || slugify(name || '');
}

const API = location.hostname.endsWith('nh48pics.com') ? '/_functions' : 'https://www.nh48pics.com/_functions';

// =============================
// New: images API cache and fetch
// =============================
const _imagesCache = new Map();
async function fetchPeakImages(slug) {
  if (_imagesCache.has(slug)) return _imagesCache.get(slug);
  try {
    const r = await fetch(API + '/nh48_images?peak=' + encodeURIComponent(slug));
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const data = await r.json();
    const imgs = Array.isArray(data?.images) ? data.images : [];
    _imagesCache.set(slug, imgs);
    return imgs;
  } catch (e) {
    console.error('Failed to load images for', slug, e);
    _imagesCache.set(slug, []);
    return [];
  }
}

/* ======= Lists (existing) ======= */
async function fetchAllLists(){ const r=await fetch(API+'/peakbagger_lists'); if(!r.ok) throw new Error('Failed to load lists'); const {lists}=await r.json(); return lists??[]; }
async function fetchListItems(name){ const r=await fetch(API+'/peakbagger_list?name='+encodeURIComponent(name)); if(!r.ok) throw new Error('Failed to load items for '+name); const {items}=await r.json(); return (items??[]).map((p,i)=>({rank:i+1,...p})); }

/* ======= Elements ======= */
const listSelect=document.getElementById('listSelect');
const rows=document.getElementById('rows');
const bar=document.getElementById('bar');
const progressText=document.getElementById('progressText');
const searchEl=document.getElementById('search');
const sortBtn=document.getElementById('sortBtn');
const sortLabel=document.getElementById('sortLabel');
const showBtn=document.getElementById('showComplete');
const exportBtn=document.getElementById('exportBtn');
const unitToggle=document.getElementById('unitToggle');
const unitLabel=document.getElementById('unitLabel');
const metersToggle=document.getElementById('metersToggle');
const themeSelect=document.getElementById('themeSelect');
const openAuthBtn=document.getElementById('openAuth');
const logoutBtn=document.getElementById('logoutBtn');
const authModal=document.getElementById('authModal');
const authName=document.getElementById('authName');
const authEmail=document.getElementById('authEmail');
const authPass=document.getElementById('authPass');
const doSigninBtn=document.getElementById('doSignin');
const doSignupBtn=document.getElementById('doSignup');
const closeAuthBtn=document.getElementById('closeAuth');
const authMsg=document.getElementById('authMsg');
const meNameEl=document.getElementById('meName');
const meEmailEl=document.getElementById('meEmail');
const signedOutBox=document.getElementById('authSignedOut');
const signedInBox=document.getElementById('authSignedIn');
const detail=document.getElementById('detail');
const dTitle=document.getElementById('detailTitle');
const dElev=document.getElementById('detailElev');
// update to new date input element
const dDate=document.getElementById('detailDateInput');
const dLocation=document.getElementById('detailLocation');
const dProm=document.getElementById('detailProm');
const dDiff=document.getElementById('detailDiff');
const listTitle=document.getElementById('listTitle');

// NEW: settings elements
const densityToggle=document.getElementById('densityToggle');
const stickyToggle=document.getElementById('stickyToggle');
const densityLabel=document.getElementById('densityLabel');
const copyrightYear=document.getElementById('copyrightYear');

// NEW: TOS elements
const tosToggle = document.getElementById('tosToggle');
const tosBox    = document.getElementById('tosBox');
const tosAgree  = document.getElementById('tosAgree');
const tosTextEl = document.getElementById('tosText');
const TOS_VERSION = '1.0';

document.getElementById('detailClose').onclick=()=>detail.classList.remove('open');

/* ======= Assets ======= */
const CHECKED_IMG   = "https://static.wixstatic.com/media/66b1b2_43cfcfcd91f6481694959e1baed6f5cf~mv2.png";
const UNCHECKED_IMG = "https://static.wixstatic.com/media/66b1b2_bf1066c3b19041c29c150fc56658b841~mv2.png";

/* ======= Core state ======= */
let ALL_LISTS=[]; let currentList='';
const cache=new Map();
let hideCompleted=false; let sortMode='rank'; let meters=false;

/* ======= GRID MODE (months) ======= */
let gridMode = false;
let completionsGrid = {}; // list -> { peakName: { "1":"YYYY-MM-DD", ... "12":"" } }
function gridKey(){ const em=getSession()||'guest'; return 'peakbagger_web_grid_v1_'+em }
function loadGrid(){ try{ completionsGrid = JSON.parse(localStorage.getItem(gridKey())||'{}') }catch{ completionsGrid = {} } }
function saveGrid(){ try{ localStorage.setItem(gridKey(), JSON.stringify(completionsGrid)) }catch{} }
function ensureGridRecord(list, peak){
  completionsGrid[list] ??= {};
  completionsGrid[list][peak] ??= {"1":"","2":"","3":"","4":"","5":"","6":"","7":"","8":"","9":"","10":"","11":"","12":""};
  const one = completions[list]?.[peak]?.date || "";
  if (one) { const m = new Date(one).getMonth()+1; const k=String(m); if(!completionsGrid[list][peak][k]) completionsGrid[list][peak][k]=one; }
  return completionsGrid[list][peak];
}
function setGridDate(list, peak, month, dateStr){
  const rec = ensureGridRecord(list, peak);
  rec[String(month)] = dateStr || "";
  saveGrid();
  // Sync classic mode
  const months = Object.values(rec).filter(Boolean);
  const any = months.length>0;
  completions[list] ??= {}; completions[list][peak] ??= {done:false,date:''};
  completions[list][peak].done = any;
  completions[list][peak].date = any ? months.sort().slice(-1)[0] : '';
  saveState();
  queueRemoteSave(); // NEW: persist remotely
}
function monthHasDate(list, peak, month){ return !!ensureGridRecord(list, peak)[String(month)]; }
function getMonthDate(list, peak, month){ return ensureGridRecord(list, peak)[String(month)] || ""; }

/* ======= Local auth & prefs (existing) ======= */
const USERS_KEY='pb_users_v1'; const SESSION_KEY='pb_session_v1';
function getUsers(){ try{return JSON.parse(localStorage.getItem(USERS_KEY)||'{}')}catch{return{}} }
function putUsers(u){ localStorage.setItem(USERS_KEY,JSON.stringify(u)) }
function getSession(){ return localStorage.getItem(SESSION_KEY)||'' }
function setSession(email){ if(email) localStorage.setItem(SESSION_KEY,email); else localStorage.removeItem(SESSION_KEY) }
function currentUser(){ const email=getSession(); if(!email) return null; const u=getUsers()[email]; return u?{email,...u}:null }
function stateKey(){ const em=getSession()||'guest'; return 'peakbagger_web_state_v3_'+em }
let completions={};
const PREF_KEY='pb_prefs_v1';
function readPrefs(){ try{return JSON.parse(localStorage.getItem(PREF_KEY)||'{}')}catch{return{}} }
function writePrefs(p){ localStorage.setItem(PREF_KEY,JSON.stringify(p)) }
function loadState(){ try{const raw=localStorage.getItem(stateKey());completions=raw?(JSON.parse(raw).completions||{}):{}}catch{completions={}} }
function saveState(){ try{localStorage.setItem(stateKey(),JSON.stringify({completions}))}catch{} }

/* ======= Terms text (short) ======= */
const TERMS_TEXT = `
<strong>Peakbagger‚Äôs Journal ‚Äì Terms & Conditions (v${TOS_VERSION})</strong><br><br>
1) Local, offline-first storage. 2) No resale of your data. 3) Outdoor safety is your responsibility. 4) Clearing browser data will remove local progress. 5) Email + hashed password are stored locally for sign-in on this device.
`;

/* ======= Helpers ======= */
async function sha256(text){ const enc=new TextEncoder().encode(text); const buf=await crypto.subtle.digest('SHA-256',enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('') }
function mkSalt(len=12){ const chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s }
async function signUp(name,email,pass,opts={}){
  email=(email||'').trim().toLowerCase();
  if(!name||!email||!pass) throw new Error('Please enter name, email, and password.');
  if(!opts.tosAgreed) throw new Error('Please agree to the Terms & Conditions.');
  const users=getUsers(); if(users[email]) throw new Error('An account already exists for this email.');
  const salt=mkSalt(); const hash=await sha256(salt+'|'+pass);
  users[email]={name,email,salt,hash,tosAcceptedAt:new Date().toISOString(),tosVersion: TOS_VERSION};
  putUsers(users); setSession(email); return users[email]
}
async function signIn(email,pass){
  email=(email||'').trim().toLowerCase();
  const users=getUsers(); const u=users[email]; if(!u) throw new Error('No account for that email.');
  const guess=await sha256(u.salt+'|'+pass); if(guess!==u.hash) throw new Error('Wrong password.');
  setSession(email); return u
}
function signOut(){ setSession('') }

function reflectAuthUI(){
  const me=currentUser();
  if(me){
    signedOutBox.style.display='none'; signedInBox.style.display='';
    meNameEl.textContent=me.name||me.email; meEmailEl.textContent=me.email||'';
  } else {
    signedOutBox.style.display=''; signedInBox.style.display='none';
    meNameEl.textContent=''; meEmailEl.textContent='';
  }
  loadState(); // load completions for this session key
  loadGrid();  // load grid for this session key
  renderTable();
  // Attempt remote load for signed-in users
  if (me && currentList) restoreFromRemote(me.email, currentList).catch(()=>{});
}

function openModal(){ authModal.classList.add('open'); authMsg.textContent=''; }
function closeModal(){ authModal.classList.remove('open'); authName.value=''; authEmail.value=''; authPass.value=''; authMsg.textContent=''; tosAgree.checked=false; doSignupBtn.disabled=true; }

function renderListDropdown(){ listSelect.innerHTML=''; ALL_LISTS.forEach(name=>{ const opt=document.createElement('option'); opt.value=name; opt.textContent=name; if(name===currentList) opt.selected=true; listSelect.appendChild(opt) }) }
function setDateFor(peakName,dateStr){ completions[currentList]??={}; completions[currentList][peakName]??={done:false,date:''}; completions[currentList][peakName].date=dateStr; if(dateStr && !completions[currentList][peakName].done){ completions[currentList][peakName].done=true } saveState(); queueRemoteSave(); renderTable() }
function toggleComplete(peakName){ completions[currentList]??={}; const rec=completions[currentList][peakName]??{done:false,date:''}; rec.done=!rec.done; if(!rec.done) rec.date=''; completions[currentList][peakName]=rec; saveState(); queueRemoteSave(); renderTable() }
function renderProgressBase(allItems){ const done=allItems.filter(it=>completions[currentList]?.[it.name]?.done).length; const total=allItems.length; const pct= total? Math.round(done/total*100):0; bar.style.width=pct+'%'; progressText.textContent=`${done}/${total} ‚Ä¢ ${pct}%`; }
function fmtElevation(ft){ if(!ft) return ''; return meters ? Math.round(ft*0.3048)+' m' : ft+' ft' }
async function baseItemsFor(listName){ if(!cache.has(listName)){ cache.set(listName, await fetchListItems(listName)) } return cache.get(listName) }
// openDetail becomes async and uses API images fallback and editable date input
async function openDetail(it){ dTitle.textContent=it.name; dElev.textContent=fmtElevation(it.elevation_ft ?? null) || '‚Äî'; dDate.value = completions[currentList]?.[it.name]?.date || '';
  // Load NH48 details for this peak
  const slug = getSlugForName(it.name);
  const data = NH48_DATA?.[slug] || null;
  // Fill additional facts
  dLocation.textContent = data?.["Range / Subrange"] || '‚Äî';
  if (dLocation.textContent === '') dLocation.textContent = '‚Äî';
  const promFt = data?.["Prominence (ft)"];
  dProm.textContent = promFt ? (meters ? Math.round(promFt*0.3048)+' m' : promFt+' ft') : '‚Äî';
  dDiff.textContent = data?.Difficulty || '‚Äî';
  // Build photo carousel
  const photoContainer = document.getElementById('detailPhotos');
  photoContainer.innerHTML = '';
  let photos = [];
  if (data && Array.isArray(data.photos) && data.photos.length > 0 && data.photos[0].url) {
    // Use the photos from the NH48 dataset only if the first photo has a valid URL
    photos = data.photos.filter(p => p && p.url);
  } else {
    // Fallback: load images via the nh48_images API
    const apiImgs = await fetchPeakImages(slug);
    photos = apiImgs.map(img => ({ url: img.url || img.thumb || '', caption: img.caption || '' })).filter(p => p.url);
  }
  // helper: clear existing carousel timer if present
  if (photoContainer._carouselTimer) { clearInterval(photoContainer._carouselTimer); photoContainer._carouselTimer = null; }
  if (photos.length > 0) {
    let idx = 0;
    const wrap = document.createElement('div'); wrap.className = 'carousel-wrap';
    const main = document.createElement('div'); main.className = 'carousel-main';
    const img = document.createElement('img'); img.alt = it.name; img.src = photos[0].url; img.className = 'carousel-main-img'; img.loading = 'lazy';
    main.appendChild(img);
    const prevBtn = document.createElement('button'); prevBtn.className = 'carousel-prev'; prevBtn.textContent = '‚Äπ';
    const nextBtn = document.createElement('button'); nextBtn.className = 'carousel-next'; nextBtn.textContent = '‚Ä∫';
    main.appendChild(prevBtn); main.appendChild(nextBtn);

    // thumbnails
    const thumbs = document.createElement('div'); thumbs.className = 'carousel-thumbs';
    const indicators = document.createElement('div'); indicators.className = 'carousel-indicators';
    const makeThumb = (p, i) => {
      const t = document.createElement('img'); t.className = 'carousel-thumb'; t.src = p.url; t.alt = it.name + ' thumbnail'; t.dataset.i = String(i); t.loading = 'lazy';
      t.addEventListener('click', (e)=>{ e.stopPropagation(); setIndex(i); });
      return t;
    };
    const setIndex = (n) => {
      idx = ((n % photos.length) + photos.length) % photos.length;
      img.src = photos[idx].url;
      // update thumbs
      thumbs.querySelectorAll('.carousel-thumb').forEach((el)=>el.classList.toggle('active', el.dataset.i==String(idx)));
      indicators.querySelectorAll('.dot').forEach((d,i)=>d.classList.toggle('active', i===idx));
    };
    photos.forEach((p,i)=>{ thumbs.appendChild(makeThumb(p,i)); const dot=document.createElement('div'); dot.className='dot'; indicators.appendChild(dot); });
    // autoplay
    const AUTOPLAY_MS = 3500;
    const startTimer = () => { if (photoContainer._carouselTimer) clearInterval(photoContainer._carouselTimer); photoContainer._carouselTimer = setInterval(()=>{ setIndex(idx+1); }, AUTOPLAY_MS); };
    const stopTimer = () => { if (photoContainer._carouselTimer) { clearInterval(photoContainer._carouselTimer); photoContainer._carouselTimer = null; } };

    prevBtn.addEventListener('click', (e)=>{ e.stopPropagation(); setIndex(idx-1); startTimer(); });
    nextBtn.addEventListener('click', (e)=>{ e.stopPropagation(); setIndex(idx+1); startTimer(); });
    main.addEventListener('mouseenter', stopTimer); main.addEventListener('mouseleave', startTimer);

    wrap.appendChild(main);
    wrap.appendChild(thumbs);
    wrap.appendChild(indicators);
    photoContainer.appendChild(wrap);
    setIndex(0);
    startTimer();
  } else {
    // no photos ‚Äî show placeholder
    const ph = document.createElement('div'); ph.style.width='100%'; ph.style.borderRadius='8px'; ph.style.overflow='hidden';
    const pimg = document.createElement('img'); pimg.alt = it.name; pimg.src = placeholderFor(it.name, 800, 420); pimg.loading = 'lazy';
    ph.appendChild(pimg);
    photoContainer.appendChild(ph);
  }
  // attach date input handlers
  dDate.onclick = (e) => e.stopPropagation();
  dDate.onchange = () => { if (dDate.value) setDateFor(it.name, dDate.value); };
  detail.classList.add('open');
}

// Generate an inline SVG placeholder data URL for peaks with no photos
function placeholderFor(name, w=800, h=420){
  const bg = encodeURIComponent('#2c2c2c');
  const fg = encodeURIComponent('#ffffff');
  const txt = encodeURIComponent(name || 'No Photo');
  const svg = `<?xml version="1.0" encoding="UTF-8"?><svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}' viewBox='0 0 ${w} ${h}'><rect width='100%' height='100%' fill='${bg}'/><g fill='${fg}' font-family='Segoe UI, Roboto, Arial' font-weight='600' font-size='28'><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'>${txt}</text></g></svg>`;
  return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
}

/* ======= Appearance helpers ======= */
function applyUnitsFlag(flag){
  meters = flag;
  metersToggle.checked = meters;
  unitLabel.textContent = meters ? 'Meters (m)' : 'Feet (ft)';
  renderTable();
  const prefs = readPrefs(); prefs.meters = meters; writePrefs(prefs);
}
function applyTheme(theme){
  // Remove known theme classes
  document.body.classList.remove('theme-light','theme-forest','theme-sky');
  if (!theme || theme === 'dark') {
    // dark = default, no class needed
  } else if (theme === 'light') {
    document.body.classList.add('theme-light');
  } else if (theme === 'forest') {
    document.body.classList.add('theme-forest');
  } else if (theme === 'sky') {
    document.body.classList.add('theme-sky');
  }
  // sync UI select if present
  if (themeSelect) themeSelect.value = theme || 'dark';
  const prefs = readPrefs(); prefs.theme = theme || 'dark'; writePrefs(prefs);
}
function applyDensity(compact){
  document.body.classList.toggle('compact-rows', !!compact);
  if (densityToggle) densityToggle.checked = !!compact;
  if (densityLabel) densityLabel.textContent = compact ? 'Compact' : 'Comfortable';
  const p = readPrefs(); p.compact = !!compact; writePrefs(p);
}
function applyStickyHeader(sticky){
  document.body.classList.toggle('sticky-header', !!sticky);
  if (stickyToggle) stickyToggle.checked = !!sticky;
  const p = readPrefs(); p.sticky = !!sticky; writePrefs(p);
}

/* ======= Remote persistence (NEW) ======= */
function summarizeCompletions(list, allItems){
  const done = allItems.filter(it=>completions[list]?.[it.name]?.done).length;
  return `${done}/${allItems.length} peaks completed`;
}
let saveTimer=null;
function queueRemoteSave(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>saveToRemote().catch(()=>{}), 400);
}

async function saveToRemote(){
  const me = currentUser(); if (!me || !currentList) return; // offline-only if not signed in
  const items = await baseItemsFor(currentList);
  const body = {
    email: me.email,
    list: currentList,
    grid: completionsGrid[currentList] || {},
    completions: summarizeCompletions(currentList, items),
    updatedAt: new Date().toISOString()
  };
  try{
    await fetch(API + '/peakbagger_progress', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
  }catch(_e){
    // stay silent ‚Äî offline-first
  }
}

async function restoreFromRemote(email, list){
  try{
    const r = await fetch(API + '/peakbagger_progress?email=' + encodeURIComponent(email) + '&list=' + encodeURIComponent(list));
    if(!r.ok) return;
    const data = await r.json();
    if (!data || !data.record) return;

    // Merge grid
    const remoteGrid = data.record.grid || {};
    completionsGrid[list] = { ...(completionsGrid[list]||{}) , ...remoteGrid };
    saveGrid();

    // Derive classic mode state from grid (latest date across months)
    completions[list] ??= {};
    Object.entries(completionsGrid[list]).forEach(([peak, monthsObj])=>{
      const dates = Object.values(monthsObj||{}).filter(Boolean).sort();
      completions[list][peak] = {
        done: dates.length>0,
        date: dates.slice(-1)[0] || ''
      };
    });
    saveState();
    renderTable();
  }catch(_e){ /* ignore */ }
}

/* ======= Pagination (NEW) ======= */
let PAGE = 1;
const PAGE_SIZE = 25;
let TOTAL_PAGES = 1;

const pgStatsTop = document.getElementById('pg-stats-top');
const pgStatsBot = document.getElementById('pg-stats-bot');
const pgListTop  = document.getElementById('pg-list-top');
const pgListBot  = document.getElementById('pg-list-bot');

function pageBounds(page, size, total){
  const maxPages = Math.max(1, Math.ceil((total||0)/size));
  const p = Math.max(1, Math.min(page, maxPages));
  const start = (p - 1) * size;
  const end = Math.min(start + size, total);
  return { p, start, end, maxPages };
}

function updatePager(total, from, to){
  const { maxPages } = pageBounds(PAGE, PAGE_SIZE, total);
  TOTAL_PAGES = maxPages;

  const label = total ? `Showing ${from}‚Äì${to} of ${total}` : 'No results';
  if (pgStatsTop) pgStatsTop.textContent = label;
  if (pgStatsBot) pgStatsBot.textContent = label;

  const buildButtons = (host) => {
    if (!host) return;
    host.innerHTML = '';

    const mk = (txt, disabled, onClick, aria) => {
      const b = document.createElement('button');
      b.className = 'page-btn'; b.textContent = txt;
      if (disabled) b.disabled = true;
      if (aria) b.setAttribute('aria-label', aria);
      b.addEventListener('click', onClick);
      return b;
    };

    // First / Prev
    host.appendChild(mk('¬´', PAGE===1, ()=>gotoPage(1), 'First page'));
    host.appendChild(mk('‚Äπ', PAGE===1, ()=>gotoPage(PAGE-1), 'Previous page'));

    // Number window ‚Äî show up to 7 numbers centered on current
    const windowSize = 7;
    let start = Math.max(1, PAGE - Math.floor(windowSize/2));
    let end   = Math.min(maxPages, start + windowSize - 1);
    start = Math.max(1, Math.min(start, Math.max(1, end - windowSize + 1)));
    for (let i=start; i<=end; i++){
      const btn = mk(String(i), false, ()=>gotoPage(i));
      if (i === PAGE) btn.setAttribute('aria-current','page');
      host.appendChild(btn);
    }

    // Next / Last
    host.appendChild(mk('‚Ä∫', PAGE===maxPages, ()=>gotoPage(PAGE+1), 'Next page'));
    host.appendChild(mk('¬ª', PAGE===maxPages, ()=>gotoPage(maxPages), 'Last page'));
  };

  buildButtons(pgListTop);
  buildButtons(pgListBot);
}

function gotoPage(p){
  const { p:clamped } = pageBounds(p, PAGE_SIZE, Number(rows?.dataset?.total || 0));
  PAGE = clamped;
  renderTable();
  try {
    const mainEl = document.querySelector('main.panel');
    const y = mainEl?.getBoundingClientRect().top + window.scrollY - 8;
    window.scrollTo({ top: y, behavior: 'smooth' });
  } catch(_) {}
}

// Keyboard shortcuts for pagination
window.addEventListener('keydown', (e)=>{
  if (e.target && (/input|select|textarea/i).test(e.target.tagName)) return;
  if (e.key === 'ArrowRight') { gotoPage(PAGE + 1); }
  if (e.key === 'ArrowLeft')  { gotoPage(PAGE - 1); }
});

/* ======= Render table (unchanged + grid + pagination) ======= */
async function renderTable(){
  if (!currentList) { rows.innerHTML = ''; return; }
  const q = searchEl.value.trim().toLowerCase();

  const allItems = (await baseItemsFor(currentList)).map(it => {
    const c = completions[currentList]?.[it.name] ?? { done:false, date:'' };
    return { ...it, completed: !!c.done, date: c.date || '' };
  });

  // sort
  allItems.sort((a,b) => {
    if (sortMode === 'name')   return a.name.localeCompare(b.name);
    if (sortMode === 'elev')   return (b.elevation_ft ?? 0) - (a.elevation_ft ?? 0);
    if (sortMode === 'status') return (b.completed ? 1 : 0) - (a.completed ? 1 : 0) || a.rank - b.rank;
    return a.rank - b.rank; // rank
  });

  // filter
  let items = allItems.filter(it => !q || it.name.toLowerCase().includes(q));
  if (hideCompleted) items = items.filter(it => !it.completed);

  // progress (default checklist)
  renderProgressBase(allItems);

  // grid progress override
  if (gridMode) {
    let totalCells = items.length * 12; let filled = 0;
    items.forEach(it=>{ const rec = ensureGridRecord(currentList, it.name); filled += Object.values(rec).filter(Boolean).length; });
    const pct = totalCells ? Math.round(filled/totalCells*100) : 0;
    bar.style.width = pct + '%';
    progressText.textContent = `${filled}/${totalCells} ‚Ä¢ ${pct}%`;
  }

  // ===== Pagination slice =====
  const total = items.length;
  const { p, start, end } = pageBounds(PAGE, PAGE_SIZE, total);
  PAGE = p;
  rows.dataset.total = String(total);
  const pageItems = items.slice(start, end);
  updatePager(total, total ? (start + 1) : 0, end);

  // rows
  rows.innerHTML = '';
  for (const it of pageItems) {
    ensureGridRecord(currentList, it.name);
    const tr = document.createElement('tr');

    // compute profile image (first photo from NH48 dataset or fallback to API) for both modes
    const slug = getSlugForName(it.name);
    let imgHtml = '';
    let profileUrl = '';
    const photoData = NH48_DATA?.[slug]?.photos;
      // Only show images if the current list has an associated API (NH 48 has NH48_DATA)
      const listHasImages = currentList && currentList.toLowerCase() === 'nh 48';
      if (listHasImages && photoData && photoData.length > 0 && photoData[0].url) {
        // Use the first dataset photo only if it has a valid URL
        profileUrl = photoData[0].url;
      } else if (listHasImages) {
        const apiImgs = await fetchPeakImages(slug);
        if (apiImgs.length > 0) {
          profileUrl = apiImgs[0].thumb || apiImgs[0].url || '';
        }
      }
    if (profileUrl) {
      imgHtml = `<img src="${profileUrl}" alt="${it.name}" class="profile-img" loading="lazy" />`;
    }

    // On mobile, render image as first grid cell; on desktop, use free-floating div
    const isMobile = window.innerWidth <= 700;
    if (imgHtml) {
      if (isMobile) {
        // Mobile: image is the first grid cell
        const picCell = document.createElement('td');
        picCell.setAttribute('data-cell', 'pic');
        picCell.innerHTML = imgHtml;
        tr.appendChild(picCell);
      } else {
        // Desktop: free-floating photo block
        const photo = document.createElement('div');
        photo.className = 'row-photo';
        photo.innerHTML = imgHtml;
        tr.appendChild(photo);
      }
    }

    if (!gridMode) {
      // Checklist row without a picture cell
      tr.innerHTML += `
        <td class="stat" data-cell="rank"><span class="cell-value">${it.rank}</span></td>
        <td data-cell="name" style="text-align:center; vertical-align:middle;">
          <span class="mountain-link" style="cursor:pointer; display:inline-flex; align-items:center; max-width:100%;">${it.name}</span>
        </td>
        <td class="stat" data-cell="elev"><span class="cell-value">${fmtElevation(it.elevation_ft ?? null)}</span></td>
        <td data-cell="date">
          <input type="date" class="date-input" required value="${it.date || ''}" data-name="${it.name}">
        </td>
        <td class="stat" data-cell="done">
          <img class="check js-check" alt="completed" src="${it.completed ? CHECKED_IMG : UNCHECKED_IMG}" loading="lazy" />
        </td>
        <td data-cell="open">‚Ä∫</td>
      `;
    } else {
      // Grid mode row without a picture cell
      const monthLabels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const chips = monthLabels.map((lbl, idx) => {
        const m = idx+1; const done = monthHasDate(currentList, it.name, m);
        const dot = done ? '<span class="dot"></span>' : '';
        return `<button class="month-chip ${done?'done':''}" data-m="${m}" title="${lbl}">${lbl}${dot}</button>`;
      }).join('');

      tr.innerHTML += `
        <td class="stat" data-cell="rank">${it.rank}</td>
        <td data-cell="name" style="text-align:center; vertical-align:middle;">
          <span class="mountain-link" style="cursor:pointer; display:inline-flex; align-items:center; max-width:100%;">${it.name}</span>
        </td>
        <td class="stat" data-cell="elev">${fmtElevation(it.elevation_ft ?? null)}</td>
        <td data-cell="months" colspan="2">
          <div class="grid-hint">Tap a month to add/edit a date.</div>
          <div class="month-strip">${chips}</div>
          <div class="month-picker">
            <input type="date" class="grid-date" value="" />
            <button class="btn btn-small btn-primary grid-save">Save</button>
            <button class="btn btn-small btn-ghost grid-clear">Clear</button>
          </div>
        </td>
        <td data-cell="open">‚Ä∫</td>
      `;
    }

    // Apply completed styling to the row if the peak is marked complete
    if (it.completed) {
      tr.classList.add('completed');
    }

    // Common handlers
    tr.querySelector('[data-cell="name"]')?.addEventListener('click', () => openDetail(it));
    tr.querySelector('[data-cell="open"]')?.addEventListener('click', () => openDetail(it));

    if (!gridMode) {
      // checklist handlers
      const dateInput = tr.querySelector('.date-input');
      dateInput?.addEventListener('click', e => e.stopPropagation());
      dateInput?.addEventListener('change', () => {
        if (dateInput.value) setDateFor(it.name, dateInput.value);
      });
      tr.querySelector('.js-check')?.addEventListener('click', (e) => {
        e.stopPropagation(); toggleComplete(it.name);
      });
    } else {
      // grid handlers
      const picker = tr.querySelector('.month-picker');
      const dateEl = tr.querySelector('.grid-date');
      let activeMonth = 0;
      tr.querySelectorAll('.month-chip').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          activeMonth = parseInt(btn.dataset.m,10);
          dateEl.value = getMonthDate(currentList, it.name, activeMonth);
          picker.classList.add('open');
          dateEl.focus();
        });
      });
      tr.querySelector('.grid-save')?.addEventListener('click', e => { e.stopPropagation(); setGridDate(currentList, it.name, activeMonth, dateEl.value); renderTable(); });
      tr.querySelector('.grid-clear')?.addEventListener('click', e => { e.stopPropagation(); setGridDate(currentList, it.name, activeMonth, ''); renderTable(); });
    }

    rows.appendChild(tr);
  }

  // Attach hover preview handlers for profile images (one-time per render)
  // Use event delegation per-row above, but we also wire detailed preview to the small circular images.
  rows.querySelectorAll('.profile-img').forEach(img => {
    let previewEl = null;
    const makePreview = () => {
      if (previewEl) return previewEl;
      previewEl = document.createElement('div'); previewEl.className = 'img-preview';
      const big = document.createElement('img'); big.alt = img.alt || ''; big.src = img.src || placeholderFor(img.alt || ''); big.loading = 'lazy'; previewEl.appendChild(big);
      document.body.appendChild(previewEl);
      return previewEl;
    };
    const movePreview = (e) => {
      const rect = img.getBoundingClientRect();
      const px = rect.right + 10;
      const py = Math.max(8, rect.top + window.scrollY - 8);
      const el = previewEl;
      if (el) {
        el.style.left = px + 'px';
        el.style.top = (rect.top + window.scrollY) + 'px';
      }
    };
    img.addEventListener('mouseenter', (e)=>{ makePreview(); previewEl.style.display='block'; movePreview(e); });
    img.addEventListener('mousemove', (e)=>{ if (previewEl) movePreview(e); });
    img.addEventListener('mouseleave', ()=>{ if (previewEl){ previewEl.remove(); previewEl = null; } });
  });
}

/* ======= List switching ======= */
async function changeList(name){
  currentList = name;
  PAGE = 1; // reset page on list change
  if (listTitle) listTitle.textContent = currentList || '‚Äî';
  await renderTable();
  // Try to restore remote for signed-in users
  const me = currentUser(); if (me) restoreFromRemote(me.email, currentList).catch(()=>{});
}

/* ======= UI handlers ======= */
listSelect.onchange=async()=>{ await changeList(listSelect.value) };
searchEl.oninput=()=>{ PAGE = 1; renderTable(); };
sortBtn.onclick=()=>{
  const modes=['rank','name','elev','status'];
  const idx=(modes.indexOf(sortMode)+1)%modes.length;
  sortMode=modes[idx];
  sortLabel.textContent=(sortMode==='elev'?'Elevation':sortMode==='status'?'Status':sortMode[0].toUpperCase()+sortMode.slice(1));
  PAGE = 1;
  renderTable();
};
showBtn.onclick=()=>{
  hideCompleted=!hideCompleted;
  showBtn.innerHTML= hideCompleted ? '<span class="ico">‚óé</span> <span>Show completed</span>' : '<span class="ico">‚óØ</span> <span>Hide completed</span>';
  PAGE = 1;
  renderTable();
};
exportBtn.onclick=async()=>{
  const base=await baseItemsFor(currentList);
  const items=base.map((it,i)=>{ const c=completions[currentList]?.[it.name] ?? {done:false,date:''}; return [i+1, it.name, fmtElevation(it.elevation_ft ?? null), c.date || '', c.done ? 'Yes':'No'] });
  const ws=XLSX.utils.aoa_to_sheet([[ 'Rank','Mountain','Elevation','Date','Completed' ], ...items]); ws['!cols']=[{wch:6},{wch:26},{wch:14},{wch:12},{wch:10}]; const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, currentList.slice(0,31)); XLSX.writeFile(wb, `${currentList.replace(/\s+/g,'_')}.xlsx`);
};

unitToggle.onclick=()=>applyUnitsFlag(!meters);
metersToggle.onchange=()=>applyUnitsFlag(metersToggle.checked);
if (themeSelect) themeSelect.onchange = () => applyTheme(themeSelect.value);

/* NEW: handlers for added settings */
densityToggle.onchange = () => applyDensity(densityToggle.checked);
stickyToggle.onchange  = () => applyStickyHeader(stickyToggle.checked);

/* NEW: TOS UI */
tosTextEl.innerHTML = TERMS_TEXT;
tosToggle.onclick = () => { tosBox.classList.toggle('open'); tosToggle.textContent = tosBox.classList.contains('open') ? 'üìÑ Hide Terms & Conditions' : 'üìÑ View Terms & Conditions'; };
tosAgree.addEventListener('change', ()=>{ doSignupBtn.disabled = !tosAgree.checked; });

// NEW: Mode toggle
const modeBtn = document.getElementById('modeBtn');
const modeLabel = document.getElementById('modeLabel');
modeBtn.onclick = () => { gridMode = !gridMode; modeLabel.textContent = gridMode ? 'Grid' : 'Checklist'; PAGE = 1; renderTable(); };

/* Auth buttons */
if(openAuthBtn) openAuthBtn.onclick=()=>openModal();
if(closeAuthBtn) closeAuthBtn.onclick=()=>closeModal();
if(logoutBtn) logoutBtn.onclick=()=>{ signOut(); reflectAuthUI(); };
if(doSigninBtn) doSigninBtn.onclick=async()=>{
  authMsg.textContent='';
  try{
    await signIn(authEmail.value, authPass.value);
    authMsg.textContent='Success!'; authMsg.className='ok';
    closeModal(); reflectAuthUI();
  }catch(e){
    authMsg.textContent=e.message||'Failed to sign in'; authMsg.className='err';
  }
};
if(doSignupBtn) doSignupBtn.onclick=async()=>{
  authMsg.textContent='';
  try{
    await signUp(authName.value, authEmail.value, authPass.value, { tosAgreed: tosAgree.checked });
    authMsg.textContent='Account created & signed in!'; authMsg.className='ok';
    closeModal(); reflectAuthUI();
  }catch(e){
    authMsg.textContent=e.message||'Failed to create account'; authMsg.className='err';
  }
};

/* ======= Boot ======= */
(async function boot(){
  try{
    const prefs=readPrefs();
    applyTheme(prefs.theme || 'dark');
    applyUnitsFlag(!!prefs.meters);
    applyDensity(!!prefs.compact);
    applyStickyHeader(!!prefs.sticky);

    if (copyrightYear) copyrightYear.textContent = new Date().getFullYear();

    reflectAuthUI();
    loadGrid();
    ALL_LISTS=await fetchAllLists();
    const preferred='NH 48';
    currentList = ALL_LISTS.includes(preferred) ? preferred : (ALL_LISTS[0] || '');
    renderListDropdown();
    if (listTitle) listTitle.textContent = currentList || '‚Äî';
    // Load NH48 API data
    await fetchNh48Data();
    await changeList(currentList);
  }catch(e){
    console.error(e);
    rows.innerHTML=`<tr><td colspan="6" class="subtle">Couldn‚Äôt load lists. Check that <code>/_functions/peakbagger_lists</code> and <code>/_functions/peakbagger_list</code> are published.</td></tr>`;
  }
})();
</script>
  
<!-- Reset helper (unchanged + grid key) -->
<button id="pbReset" style="border:1px solid #ff8a8a;border-radius:8px;padding:8px 10px;background:#1a1a1a;color:#fff;cursor:pointer">
  Reset all local data
</button>
<script>
  (function(){
    const KEYS_PREFIX = ['peakbagger_web_state_v3_', 'peakbagger_web_grid_v1_', 'pb_'];
    document.getElementById('pbReset')?.addEventListener('click', () => {
      if (!confirm('This will erase your saved progress, dates, sign-in, and preferences on this device. Continue?')) return;
      try {
        const toDelete = [];
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i);
          if (k && KEYS_PREFIX.some(p => k.startsWith(p))) toDelete.push(k);
        }
        toDelete.forEach(k => localStorage.removeItem(k));
        ['pb_users_v1','pb_session_v1','pb_prefs_v1'].forEach(k => localStorage.removeItem(k));
        alert('All Peakbagger data on this device has been cleared.');
        location.reload();
      } catch (e) {
        alert('Could not clear local data. You can manually clear site data in your browser settings.');
      }
    });
  })();
</script>

  <!-- Auto-collapse details on mobile (NEW) -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const settingsEl = document.getElementById('settingsDetails');
      const resourcesEl = document.getElementById('resourcesDetails');
      function toggleDetailsByWidth() {
        const isMobile = window.innerWidth < 960;
        if (settingsEl) {
          if (isMobile) settingsEl.removeAttribute('open'); else settingsEl.setAttribute('open', '');
        }
        if (resourcesEl) {
          if (isMobile) resourcesEl.removeAttribute('open'); else resourcesEl.setAttribute('open', '');
        }
      }
      toggleDetailsByWidth();
      window.addEventListener('resize', toggleDetailsByWidth);
    });
  </script>

<!-- Noscript notice -->
<noscript>
  <div style="margin:12px; padding:12px; border:1px solid #e6a100; border-radius:8px; background:#2a2000; color:#ffd87a">
    Peakbagger‚Äôs Journal needs JavaScript for list loading and saving progress. Please enable JavaScript to use the app.
  </div>
</noscript>
</noscript>

<!-- Version badge -->
<div class="app-version" aria-hidden="true">v0.8.0.1</div>

</body>
</html>
