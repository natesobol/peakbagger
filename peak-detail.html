<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Peak Details - Peakbagger's Journal</title>
  <link rel="stylesheet" href="peak-detail.css">
</head>
<body>
  <div class="wrap">
    <a href="peakbagger-clean.html" class="back">‚Üê Back to Peakbagger</a>
    
    <h1 id="peakName">Loading‚Ä¶</h1>
    
    <!-- MEDIA / CAROUSEL -->
    <div class="media" id="media">
      <div class="carousel" id="carousel"></div>
      <div class="dots" id="dots"></div>
      <div class="ctrls">
        <button id="prevBtn" aria-label="Previous image">‚Äπ</button>
        <button id="nextBtn" aria-label="Next image">‚Ä∫</button>
      </div>
      <div class="timer" id="carouselTimer">
        <svg viewBox="0 0 40 40">
          <circle id="timerRing" class="timer-ring" cx="20" cy="20" r="18"></circle>
        </svg>
        <span id="timerText" class="timer-text"></span>
      </div>
    </div>
    
    <!-- METADATA + INFO SIDE BY SIDE -->
    <div class="meta-info-row">
      <div id="fastFactsPanel" class="metadata-panel">
        <div class="metadata-header">
          <div class="metadata-title">General Peak Info</div>
        </div>
        <div class="metadata-primary">
          <div class="metadata-row">
            <div class="metadata-label">Elevation</div>
            <div class="metadata-value" id="elevation">‚Äî</div>
          </div>
          <div class="metadata-row">
            <div class="metadata-label">Prominence</div>
            <div class="metadata-value" id="prominence">‚Äî</div>
          </div>
          <div class="metadata-row">
            <div class="metadata-label">Range</div>
            <div class="metadata-value" id="location">‚Äî</div>
          </div>
          <div class="metadata-row">
            <div class="metadata-label">Trail Type</div>
            <div class="metadata-value" id="trailType">‚Äî</div>
          </div>
          <div class="metadata-row">
            <div class="metadata-label">Difficulty</div>
            <div class="metadata-value" id="difficulty">‚Äî</div>
          </div>
          <div class="metadata-row">
            <div class="metadata-label">Exposure</div>
            <div class="metadata-value" id="exposure">‚Äî</div>
          </div>
        </div>
        <div class="btn-row">
          <button class="btn" id="favBtn"><span id="favIcon">‚òÜ</span> <span id="favText">Favorite</span></button>
          <button class="btn" id="wishBtn"><span id="wishIcon">ü§ç</span> <span id="wishText">Wishlist</span></button>
        </div>
      </div>
      
      <div id="progressPanel" class="metadata-panel">
        <div class="metadata-header">
          <div class="metadata-title">Your Progress</div>
        </div>
        <div class="metadata-primary">
          <div class="metadata-row">
            <div class="metadata-label">Date Completed</div>
            <div class="metadata-value"><input type="date" id="dateInput" class="date-input" /></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- LEARN MORE -->
    <div class="section-title">Learn More</div>
    <div class="info-grid">
      <div class="info-panel">
        <div class="info-label">External Resources</div>
        <div class="links-col">
          <a class="btn-link primary" id="lnkNH48" href="#" target="_blank" rel="noopener" style="display:none">üèîÔ∏è View Full NH48 Peak Details ‚Üí</a>
          <a class="btn-link" id="lnkWikipedia" href="#" target="_blank" rel="noopener">Wikipedia</a>
          <a class="btn-link" id="lnkPeakbagger" href="#" target="_blank" rel="noopener">Peakbagger.com</a>
          <a class="btn-link" id="lnkAllTrails" href="#" target="_blank" rel="noopener">AllTrails</a>
          <a class="btn-link" id="lnkSummitPost" href="#" target="_blank" rel="noopener">SummitPost</a>
          <a class="btn-link" id="lnkMaps" href="#" target="_blank" rel="noopener">OpenStreetMap</a>
        </div>
      </div>
      <div class="info-panel">
        <div class="info-label">Weather Forecasts</div>
        <p class="subtle">Links open in a new tab.</p>
        <div class="links-col">
          <a class="btn-link" id="wxNoaa" href="#" target="_blank" rel="noopener">NOAA Point Forecast</a>
          <a class="btn-link" id="wxOpenMeteo" href="#" target="_blank" rel="noopener">Open-Meteo</a>
          <a class="btn-link" href="https://trailsnh.com/" target="_blank" rel="noopener">TrailsNH Summit Forecast</a>
          <a class="btn-link" href="https://www.mountwashington.org/experience-the-weather/" target="_blank" rel="noopener">MWOBS (Presidentials)</a>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    const params = new URLSearchParams(window.location.search);
    const peakSlug = params.get('slug');
    
    const API_URLS = [
      'https://cdn.jsdelivr.net/gh/natesobol/nh48-api@main/data/nh48.json',
      'https://raw.githubusercontent.com/natesobol/nh48-api/main/data/nh48.json'
    ];
    
    const PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(
      '<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#172032"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="22">No photos available</text></svg>'
    );
    
    let carouselImgs = [], carouselIdx = 0, carouselTimer = null, timerInterval = null;
    const BASE_DELAY = 8000;
    
    function cleanJSON(raw) {
      return raw.replace(/:contentReference\[.*?\]\{index=\d+\}/g, '').replace(/\/\*\s*Lines?\s+\d+[\d\-,\s]*omitted\s*\*\//g, '');
    }
    
    async function fetchFromNH48API() {
      for (let i = 0; i < API_URLS.length; i++) {
        try {
          const res = await fetch(API_URLS[i], { mode: 'cors' });
          if (!res.ok) continue;
          const text = await res.text();
          return JSON.parse(cleanJSON(text));
        } catch (err) { console.log('Fetch error:', err); }
      }
      throw new Error('All API endpoints failed');
    }
    
    async function loadPeakData() {
      if (!peakSlug) { document.getElementById('peakName').textContent = 'Peak not found'; return; }
      
      try {
        const stored = localStorage.getItem('peakbagger_peaks');
        if (stored) {
          const peaks = JSON.parse(stored);
          const peak = peaks.find(p => p.slug === peakSlug);
          if (peak) { renderPeak(peak); return; }
        }
        
        const data = await fetchFromNH48API();
        const apiPeak = data[peakSlug];
        
        if (apiPeak) {
          const peak = {
            slug: peakSlug,
            name: apiPeak.peakName || apiPeak['Peak Name'] || peakSlug,
            elevation: apiPeak['Elevation (ft)'] || apiPeak.elevation,
            location: apiPeak['Range / Subrange'] || apiPeak.range,
            prominence: apiPeak['Prominence (ft)'] || apiPeak.prominence,
            difficulty: apiPeak['Difficulty'] || apiPeak.difficulty,
            trailType: apiPeak['Trail Type'] || '',
            exposure: apiPeak['Exposure Level'] || apiPeak['Weather Exposure Rating'] || '',
            lat: apiPeak.latitude, lon: apiPeak.longitude,
            photos: apiPeak.photos || []
          };
          renderPeak(peak);
          return;
        }
        document.getElementById('peakName').textContent = 'Peak not found';
      } catch (err) {
        console.error('Error:', err);
        document.getElementById('peakName').textContent = 'Error loading peak';
      }
    }
    
    function renderPeak(peak) {
      document.getElementById('peakName').textContent = peak.name;
      document.title = `${peak.name} - Peakbagger's Journal`;
      
      buildCarousel(peak);
      
      document.getElementById('elevation').textContent = peak.elevation ? `${peak.elevation}'` : '‚Äî';
      document.getElementById('prominence').textContent = peak.prominence ? `${peak.prominence}'` : '‚Äî';
      document.getElementById('location').textContent = peak.location || '‚Äî';
      document.getElementById('trailType').textContent = peak.trailType || '‚Äî';
      document.getElementById('difficulty').textContent = peak.difficulty || '‚Äî';
      document.getElementById('exposure').textContent = peak.exposure || '‚Äî';
      
      const completionDate = localStorage.getItem(`peak_${peak.slug}_date`);
      if (completionDate) document.getElementById('dateInput').value = completionDate;
      
      document.getElementById('dateInput').addEventListener('change', (e) => {
        localStorage.setItem(`peak_${peak.slug}_date`, e.target.value);
      });
      
      const favorites = JSON.parse(localStorage.getItem('peakbagger_favorites') || '[]');
      const wishlist = JSON.parse(localStorage.getItem('peakbagger_wishlist') || '[]');
      updateFavBtn(favorites.includes(peak.slug));
      updateWishBtn(wishlist.includes(peak.slug));
      
      document.getElementById('favBtn').addEventListener('click', () => toggleFavorite(peak.slug));
      document.getElementById('wishBtn').addEventListener('click', () => toggleWishlist(peak.slug));
      
      if (peak.lat && peak.lon) {
        document.getElementById('wxNoaa').href = `https://forecast.weather.gov/MapClick.php?lat=${peak.lat}&lon=${peak.lon}`;
        document.getElementById('wxOpenMeteo').href = `https://open-meteo.com/en/docs#latitude=${peak.lat}&longitude=${peak.lon}`;
      }
      
      const searchName = encodeURIComponent(peak.name);
      if (peak.slug) {
        const nh48Link = document.getElementById('lnkNH48');
        nh48Link.href = `https://natesobol.github.io/nh48-api/nh48_peak.html?slug=${peak.slug}`;
        nh48Link.style.display = 'block';
      }
      
      document.getElementById('lnkWikipedia').href = `https://en.wikipedia.org/wiki/${searchName}`;
      document.getElementById('lnkPeakbagger').href = `https://www.peakbagger.com/search.aspx?name=${searchName}`;
      document.getElementById('lnkAllTrails').href = `https://www.alltrails.com/search?q=${searchName}`;
      document.getElementById('lnkSummitPost').href = `https://www.summitpost.org/search?search=${searchName}`;
      if (peak.lat && peak.lon) {
        document.getElementById('lnkMaps').href = `https://www.openstreetmap.org/?mlat=${peak.lat}&mlon=${peak.lon}&zoom=14`;
      }
    }
    
    function buildCarousel(peak) {
      const carouselEl = document.getElementById('carousel');
      const dotsEl = document.getElementById('dots');
      carouselEl.innerHTML = ''; dotsEl.innerHTML = '';
      carouselImgs = []; carouselIdx = 0;
      
      let images = [];
      if (peak.photos && Array.isArray(peak.photos) && peak.photos.length > 0) {
        images = peak.photos.map(p => typeof p === 'string' ? p : (p && p.url ? p.url : null)).filter(Boolean);
      }
      if (images.length === 0) images = [PLACEHOLDER];
      carouselImgs = images;
      
      images.forEach((src, i) => {
        const slide = document.createElement('div');
        slide.className = 'slide' + (i === 0 ? ' active' : '');
        const img = document.createElement('img');
        img.alt = `${peak.name} image ${i + 1}`;
        if (i === 0) { img.src = src; } else { img.loading = 'lazy'; img.dataset.src = src; }
        slide.appendChild(img);
        carouselEl.appendChild(slide);
        
        const dot = document.createElement('div');
        dot.className = 'dot' + (i === 0 ? ' active' : '');
        dot.addEventListener('click', () => goToSlide(i));
        dotsEl.appendChild(dot);
      });
      
      if (images.length > 1) { startCarousel(); document.getElementById('carouselTimer').style.display = 'flex'; }
      else { document.getElementById('carouselTimer').style.display = 'none'; }
    }
    
    function goToSlide(index) {
      const slides = document.querySelectorAll('.slide');
      const dots = document.querySelectorAll('.dot');
      slides[carouselIdx].classList.remove('active');
      dots[carouselIdx].classList.remove('active');
      carouselIdx = index;
      const img = slides[carouselIdx].querySelector('img');
      if (img.dataset.src && !img.src) img.src = img.dataset.src;
      slides[carouselIdx].classList.add('active');
      dots[carouselIdx].classList.add('active');
      resetCarousel();
    }
    
    function nextSlide() { goToSlide((carouselIdx + 1) % carouselImgs.length); }
    function prevSlide() { goToSlide((carouselIdx - 1 + carouselImgs.length) % carouselImgs.length); }
    
    function startCarousel() {
      stopCarousel();
      const delay = BASE_DELAY + Math.random() * 2000;
      carouselTimer = setTimeout(nextSlide, delay);
      startTimer(delay);
    }
    
    function stopCarousel() {
      if (carouselTimer) { clearTimeout(carouselTimer); carouselTimer = null; }
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    }
    
    function resetCarousel() { startCarousel(); }
    
    function startTimer(duration) {
      const ring = document.getElementById('timerRing');
      const textEl = document.getElementById('timerText');
      const circumference = 2 * Math.PI * 18;
      ring.style.strokeDasharray = circumference;
      ring.style.strokeDashoffset = 0;
      const startTime = Date.now();
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const remaining = duration - (Date.now() - startTime);
        const percent = Math.max(0, remaining / duration);
        ring.style.strokeDashoffset = circumference * (1 - percent);
        textEl.textContent = remaining > 0 ? Math.ceil(remaining / 1000) : '';
        if (remaining <= 0) { clearInterval(timerInterval); timerInterval = null; }
      }, 100);
      textEl.textContent = Math.ceil(duration / 1000);
    }
    
    document.getElementById('prevBtn').addEventListener('click', prevSlide);
    document.getElementById('nextBtn').addEventListener('click', nextSlide);
    document.getElementById('media').addEventListener('mouseenter', stopCarousel);
    document.getElementById('media').addEventListener('mouseleave', () => { if (carouselImgs.length > 1) startCarousel(); });
    
    function toggleFavorite(slug) {
      const favorites = JSON.parse(localStorage.getItem('peakbagger_favorites') || '[]');
      const idx = favorites.indexOf(slug);
      if (idx > -1) favorites.splice(idx, 1); else favorites.push(slug);
      localStorage.setItem('peakbagger_favorites', JSON.stringify(favorites));
      updateFavBtn(favorites.includes(slug));
    }
    
    function updateFavBtn(isFavorite) {
      document.getElementById('favIcon').textContent = isFavorite ? '‚≠ê' : '‚òÜ';
      document.getElementById('favText').textContent = isFavorite ? 'Favorited' : 'Favorite';
    }
    
    function toggleWishlist(slug) {
      const wishlist = JSON.parse(localStorage.getItem('peakbagger_wishlist') || '[]');
      const idx = wishlist.indexOf(slug);
      if (idx > -1) wishlist.splice(idx, 1); else wishlist.push(slug);
      localStorage.setItem('peakbagger_wishlist', JSON.stringify(wishlist));
      updateWishBtn(wishlist.includes(slug));
    }
    
    function updateWishBtn(isWishlist) {
      document.getElementById('wishIcon').textContent = isWishlist ? '‚ù§Ô∏è' : 'ü§ç';
      document.getElementById('wishText').textContent = isWishlist ? 'Wishlisted' : 'Wishlist';
    }
    
    loadPeakData();
  </script>
</body>
</html>
