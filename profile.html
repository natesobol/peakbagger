<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Profile Settings - Peakbagger's Journal</title>
<link rel="stylesheet" href="styles.css">
<style>
.profile-page {
  max-width: 800px;
  margin: 0 auto;
  padding: 40px 20px;
  min-height: 100vh;
  background: var(--bg);
}

.profile-header {
  margin-bottom: 32px;
}

.profile-header h1 {
  margin: 0 0 8px 0;
  color: var(--ink);
}

.profile-header .subtitle {
  color: var(--ink-weak);
  font-size: 14px;
}

.profile-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
}

.profile-card h2 {
  margin: 0 0 20px 0;
  font-size: 18px;
  color: var(--ink);
  border-bottom: 1px solid var(--border);
  padding-bottom: 12px;
}

.profile-avatar {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 24px;
}

.profile-avatar-icon {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), #6b8cff);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36px;
  color: white;
  font-weight: 600;
  border: 3px solid var(--border);
}

.profile-avatar-info h3 {
  margin: 0 0 4px 0;
  color: var(--ink);
  font-size: 20px;
}

.profile-avatar-info p {
  margin: 0;
  color: var(--ink-weak);
  font-size: 14px;
}

.info-grid {
  display: grid;
  gap: 16px;
}

.info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}

.info-item:last-child {
  border-bottom: none;
}

.info-item label {
  color: var(--ink-weak);
  font-size: 14px;
  font-weight: 500;
}

.info-item .value {
  color: var(--ink);
  font-weight: 500;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: var(--ink);
  font-weight: 500;
  font-size: 14px;
}

.form-group input {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--input-bg);
  color: var(--ink);
  font-size: 14px;
  transition: border-color 0.2s;
}

.form-group input:focus {
  outline: none;
  border-color: var(--accent);
}

.form-group .hint {
  margin-top: 6px;
  font-size: 13px;
  color: var(--ink-weak);
}

.btn-group {
  display: flex;
  gap: 12px;
  margin-top: 24px;
}

.message {
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 20px;
  font-size: 14px;
}

.message.success {
  background: rgba(61, 220, 132, 0.1);
  color: var(--good);
  border-left: 3px solid var(--good);
}

.message.error {
  background: rgba(255, 107, 107, 0.1);
  color: #ff6b6b;
  border-left: 3px solid #ff6b6b;
}

.danger-zone {
  margin-top: 32px;
  padding-top: 24px;
  border-top: 2px solid var(--border);
}

.danger-zone h3 {
  color: #ff6b6b;
  margin: 0 0 12px 0;
  font-size: 16px;
}

.danger-zone .btn-danger {
  background: rgba(255, 107, 107, 0.1);
  color: #ff6b6b;
  border: 1px solid #ff6b6b;
}

.danger-zone .btn-danger:hover {
  background: rgba(255, 107, 107, 0.2);
}

@media (max-width: 640px) {
  .profile-page {
    padding: 20px 16px;
  }
  
  .profile-avatar {
    flex-direction: column;
    text-align: center;
  }
  
  .btn-group {
    flex-direction: column;
  }
  
  .btn-group .btn {
    width: 100%;
  }
}

/* Hike Logs Styles */
.hike-logs-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
}

.hike-logs-table th {
  text-align: left;
  padding: 12px;
  background: var(--bg);
  color: var(--ink-weak);
  font-size: 13px;
  font-weight: 600;
  border-bottom: 2px solid var(--border);
}

.hike-logs-table td {
  padding: 12px;
  border-bottom: 1px solid var(--border);
  color: var(--ink);
  font-size: 14px;
}

.hike-logs-table tr:hover {
  background: var(--bg);
}

.no-logs-message {
  text-align: center;
  padding: 32px;
  color: var(--ink-weak);
  font-size: 14px;
}

/* Social Styles */
.social-container {
  display: grid;
  gap: 24px;
  grid-template-columns: 1fr 1fr;
  margin-top: 24px;
}

.social-section {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
}

.social-section h3 {
  margin: 0 0 16px 0;
  font-size: 16px;
  color: var(--ink);
  border-bottom: 1px solid var(--border);
  padding-bottom: 10px;
}

.search-box {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.search-box input {
  flex: 1;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--input-bg);
  color: var(--ink);
  font-size: 14px;
}

.search-box button {
  padding: 10px 20px;
}

.user-list, .friend-list, .request-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.user-item, .friend-item, .request-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 8px;
  transition: background 0.2s;
}

.user-item:hover, .friend-item:hover, .request-item:hover {
  background: var(--bg);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.user-avatar-small {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), #6b8cff);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: white;
  font-weight: 600;
}

.user-details {
  flex: 1;
}

.user-details .name {
  font-weight: 600;
  color: var(--ink);
  font-size: 14px;
  margin-bottom: 2px;
}

.user-details .email {
  font-size: 12px;
  color: var(--ink-weak);
}

.action-buttons {
  display: flex;
  gap: 6px;
}

.btn-icon {
  padding: 6px 12px;
  font-size: 13px;
  border-radius: 6px;
}

.empty-state {
  text-align: center;
  padding: 24px;
  color: var(--ink-weak);
  font-size: 14px;
}

.badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.badge-pending {
  background: rgba(255, 193, 7, 0.15);
  color: #ffc107;
}

.badge-accepted {
  background: rgba(61, 220, 132, 0.15);
  color: var(--good);
}

/* Toggle Switch */
.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 26px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--border);
  transition: 0.3s;
  border-radius: 26px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: var(--accent);
}

input:checked + .slider:before {
  transform: translateX(24px);
}

@media (max-width: 960px) {
  .social-container {
    grid-template-columns: 1fr;
  }
  
  .hike-logs-table {
    font-size: 12px;
  }
  
  .hike-logs-table th,
  .hike-logs-table td {
    padding: 8px;
  }
}
</style>
</head>
<body>

<div class="profile-page">
  <div class="profile-header">
    <button onclick="window.location.href='peakbagger-clean.html'" class="btn btn-ghost btn-small" style="margin-bottom: 16px;">
      ‚Üê Back to Peakbagger
    </button>
    <h1>Profile Settings</h1>
    <p class="subtitle">Manage your account information and security settings</p>
  </div>

  <!-- User Information Card -->
  <div class="profile-card">
    <h2>User Information</h2>
    
    <div class="profile-avatar">
      <div class="profile-avatar-icon" id="profileAvatarIcon">
        <span id="profileInitials">U</span>
      </div>
      <div class="profile-avatar-info">
        <h3 id="profileName">Loading...</h3>
        <p id="profileEmail">Loading...</p>
      </div>
    </div>

    <div class="info-grid">
      <div class="info-item">
        <label>Account Created</label>
        <span class="value" id="accountCreated">‚Äî</span>
      </div>
      <div class="info-item">
        <label>Last Sign In</label>
        <span class="value" id="lastSignIn">‚Äî</span>
      </div>
      <div class="info-item">
        <label>User ID</label>
        <span class="value subtle" id="userId" style="font-family: monospace; font-size: 12px;">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- Recent Hikes Card -->
  <div class="profile-card">
    <h2>Recent Hikes</h2>
    <div id="hikesContainer">
      <div class="no-logs-message">Loading hikes...</div>
    </div>
  </div>

  <!-- Social Features -->
  <div class="profile-card">
    <h2>Social</h2>
    
    <div class="social-container">
      <!-- User Search -->
      <div class="social-section">
        <h3>üîç Find Friends</h3>
        <div class="search-box">
          <input type="text" id="userSearchInput" placeholder="Search by name or email...">
          <button class="btn btn-primary btn-small" id="searchUsersBtn">Search</button>
        </div>
        <ul id="searchResults" class="user-list"></ul>
      </div>

      <!-- Friend Requests -->
      <div class="social-section">
        <h3>üì¨ Friend Requests</h3>
        <ul id="friendRequests" class="request-list">
          <li class="empty-state">No pending requests</li>
        </ul>
      </div>

      <!-- Friends List -->
      <div class="social-section" style="grid-column: 1 / -1;">
        <h3>üë• My Friends</h3>
        <ul id="friendsList" class="friend-list">
          <li class="empty-state">No friends yet</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Change Password Card -->
  <div class="profile-card">
    <h2>Change Password</h2>
    
    <div id="passwordMessage" class="message" style="display: none;"></div>

    <form id="changePasswordForm">
      <div class="form-group">
        <label for="currentPassword">Current Password *</label>
        <input type="password" id="currentPassword" autocomplete="current-password" required>
      </div>

      <div class="form-group">
        <label for="newPassword">New Password *</label>
        <input type="password" id="newPassword" autocomplete="new-password" required>
        <p class="hint">Must be at least 6 characters</p>
      </div>

      <div class="form-group">
        <label for="confirmPassword">Confirm New Password *</label>
        <input type="password" id="confirmPassword" autocomplete="new-password" required>
      </div>

      <div class="btn-group">
        <button type="submit" class="btn btn-primary">Update Password</button>
        <button type="reset" class="btn btn-ghost">Cancel</button>
      </div>
    </form>
  </div>

  <!-- Danger Zone -->
  <div class="profile-card">
    <div class="danger-zone">
      <h3>‚ö†Ô∏è Danger Zone</h3>
      <p style="color: var(--ink-weak); font-size: 14px; margin: 0 0 16px 0;">
        These actions are permanent and cannot be undone.
      </p>
      <button class="btn btn-danger" id="signOutBtn">Sign Out</button>
    </div>
  </div>
</div>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script type="module">
  // Initialize Supabase with persistent session
  const supabaseUrl = 'https://uobvavnsstrgyezcklib.supabase.co';
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvYnZhdm5zc3RyZ3llemNrbGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0ODEzNTksImV4cCI6MjA4MTA1NzM1OX0.KL32AFytJcOC5RPEPlWlCzBDiA8N_Su9qb0yXT2n2ZI';
  
  const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      storage: window.localStorage
    }
  });

  let currentUser = null;
  let currentListId = null;

  // DOM elements
  const profileName = document.getElementById('profileName');
  const profileEmail = document.getElementById('profileEmail');
  const profileInitials = document.getElementById('profileInitials');
  const accountCreated = document.getElementById('accountCreated');
  const lastSignIn = document.getElementById('lastSignIn');
  const userId = document.getElementById('userId');
  const changePasswordForm = document.getElementById('changePasswordForm');
  const passwordMessage = document.getElementById('passwordMessage');
  const signOutBtn = document.getElementById('signOutBtn');
  const userSearchInput = document.getElementById('userSearchInput');
  const searchUsersBtn = document.getElementById('searchUsersBtn');
  const searchResults = document.getElementById('searchResults');
  const friendRequests = document.getElementById('friendRequests');
  const friendsList = document.getElementById('friendsList');

  // Load user data
  async function loadUserProfile() {
    const { data: { user }, error } = await supabase.auth.getUser();
    
    if (error || !user) {
      // Not logged in, redirect to main page
      window.location.href = 'peakbagger-clean.html';
      return;
    }

    currentUser = user;

    // Update UI with user data
    const firstName = user.user_metadata?.first_name || user.user_metadata?.name || 'User';
    const lastName = user.user_metadata?.last_name || '';
    const fullName = lastName ? `${firstName} ${lastName}` : firstName;

    profileName.textContent = fullName;
    profileEmail.textContent = user.email || '';
    userId.textContent = user.id;

    // Set initials
    const initials = firstName.charAt(0).toUpperCase() + (lastName ? lastName.charAt(0).toUpperCase() : '');
    profileInitials.textContent = initials || 'U';

    // Format dates
    if (user.created_at) {
      accountCreated.textContent = new Date(user.created_at).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    if (user.last_sign_in_at) {
      lastSignIn.textContent = new Date(user.last_sign_in_at).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
  }

  // Show message
  function showMessage(text, isError = false) {
    passwordMessage.textContent = text;
    passwordMessage.className = 'message ' + (isError ? 'error' : 'success');
    passwordMessage.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      passwordMessage.style.display = 'none';
    }, 5000);
  }

  // Handle password change
  changePasswordForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    // Validate passwords match
    if (newPassword !== confirmPassword) {
      showMessage('New passwords do not match', true);
      return;
    }

    // Validate password length
    if (newPassword.length < 6) {
      showMessage('Password must be at least 6 characters', true);
      return;
    }

    try {
      // First verify current password by trying to sign in
      const { error: signInError } = await supabase.auth.signInWithPassword({
        email: currentUser.email,
        password: currentPassword
      });

      if (signInError) {
        showMessage('Current password is incorrect', true);
        return;
      }

      // Update password
      const { error: updateError } = await supabase.auth.updateUser({
        password: newPassword
      });

      if (updateError) {
        showMessage(updateError.message, true);
        return;
      }

      // Success
      showMessage('Password updated successfully!');
      changePasswordForm.reset();
    } catch (err) {
      showMessage('An error occurred. Please try again.', true);
      console.error(err);
    }
  });

  // Handle sign out
  signOutBtn.addEventListener('click', async () => {
    if (!confirm('Are you sure you want to sign out?')) return;
    
    await supabase.auth.signOut();
    window.location.href = 'peakbagger-clean.html';
  });

  // Load profile on page load
  loadUserProfile();
  
  // =====================================================
  // Hike Logs
  // =====================================================
  async function loadRecentHikes() {
    if (!currentUser) return;
    
    try {
      const { data: hikes, error } = await supabase
        .from('user_hike_logs')
        .select(`
          *,
          peaks(name, slug),
          lists(name)
        `)
        .eq('user_id', currentUser.id)
        .order('hike_date', { ascending: false })
        .limit(10);
      
      if (error) throw error;
      
      if (!hikes || hikes.length === 0) {
        hikesContainer.innerHTML = '<div class="no-logs-message">No hikes logged yet</div>';
        return;
      }
      
      const tableHtml = `
        <table class="hike-logs-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Peak</th>
              <th>List</th>
              <th>Trail</th>
              <th>Miles</th>
              <th>Duration</th>
            </tr>
          </thead>
          <tbody>
            ${hikes.map(hike => `
              <tr>
                <td>${new Date(hike.hike_date).toLocaleDateString()}</td>
                <td>${hike.peaks?.name || '‚Äî'}</td>
                <td>${hike.lists?.name || '‚Äî'}</td>
                <td>${hike.trail_name || '‚Äî'}</td>
                <td>${hike.miles ? parseFloat(hike.miles).toFixed(1) : '‚Äî'}</td>
                <td>${hike.duration_minutes ? Math.floor(hike.duration_minutes / 60) + 'h ' + (hike.duration_minutes % 60) + 'm' : '‚Äî'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      hikesContainer.innerHTML = tableHtml;
    } catch (e) {
      console.error('Error loading hikes:', e);
      hikesContainer.innerHTML = '<div class="no-logs-message">Error loading hikes</div>';
    }
  }
  
  // =====================================================
  // Social Features - User Search
  // =====================================================
  async function searchUsers() {
    const query = userSearchInput.value.trim().toLowerCase();
    if (!query || query.length < 2) {
      searchResults.innerHTML = '<li class="empty-state">Enter at least 2 characters</li>';
      return;
    }
    
    try {
      const { data: users, error } = await supabase
        .from('profiles')
        .select('id, email, display_name')
        .or(`display_name.ilike.%${query}%,email.ilike.%${query}%`)
        .neq('id', currentUser.id)
        .limit(10);
      
      if (error) throw error;
      
      if (!users || users.length === 0) {
        searchResults.innerHTML = '<li class="empty-state">No users found</li>';
        return;
      }
      
      // Check which users are already friends or have pending requests
      const { data: existingFriendships } = await supabase
        .from('friendships')
        .select('friend_user_id')
        .eq('user_id', currentUser.id);
      
      const { data: sentRequests } = await supabase
        .from('friend_requests')
        .select('to_user_id')
        .eq('from_user_id', currentUser.id)
        .eq('status', 'pending');
      
      const friendIds = new Set(existingFriendships?.map(f => f.friend_user_id) || []);
      const requestIds = new Set(sentRequests?.map(r => r.to_user_id) || []);
      
      searchResults.innerHTML = users.map(user => {
        const initials = getInitials(user.display_name || user.email);
        const isFriend = friendIds.has(user.id);
        const hasPendingRequest = requestIds.has(user.id);
        
        let actionButton = '';
        if (isFriend) {
          actionButton = '<span class="badge badge-accepted">Friends</span>';
        } else if (hasPendingRequest) {
          actionButton = '<span class="badge badge-pending">Pending</span>';
        } else {
          actionButton = `<button class="btn btn-primary btn-icon" onclick="sendFriendRequest('${user.id}')">Add Friend</button>`;
        }
        
        return `
          <li class="user-item">
            <div class="user-info">
              <div class="user-avatar-small">${initials}</div>
              <div class="user-details">
                <div class="name">${user.display_name || 'User'}</div>
                <div class="email">${user.email}</div>
              </div>
            </div>
            <div class="action-buttons">
              ${actionButton}
            </div>
          </li>
        `;
      }).join('');
    } catch (e) {
      console.error('Error searching users:', e);
      searchResults.innerHTML = '<li class="empty-state">Error searching users</li>';
    }
  }
  
  function getInitials(name) {
    if (!name) return 'U';
    const parts = name.split(' ');
    if (parts.length >= 2) {
      return parts[0][0].toUpperCase() + parts[1][0].toUpperCase();
    }
    return name.substring(0, 2).toUpperCase();
  }
  
  // Make sendFriendRequest globally accessible
  window.sendFriendRequest = async function(toUserId) {
    try {
      const { error } = await supabase
        .from('friend_requests')
        .insert({
          from_user_id: currentUser.id,
          to_user_id: toUserId,
          status: 'pending'
        });
      
      if (error) throw error;
      
      // Refresh search results
      await searchUsers();
      showMessage('Friend request sent!');
    } catch (e) {
      console.error('Error sending friend request:', e);
      showMessage('Error sending friend request', true);
    }
  };
  
  // =====================================================
  // Social Features - Friend Requests
  // =====================================================
  async function loadFriendRequests() {
    if (!currentUser) return;
    
    try {
      const { data: requests, error } = await supabase
        .from('friend_requests')
        .select(`
          *,
          from_user:profiles!friend_requests_from_user_id_fkey(id, email, display_name)
        `)
        .eq('to_user_id', currentUser.id)
        .eq('status', 'pending')
        .order('created_at', { ascending: false });
      
      if (error) throw error;
      
      if (!requests || requests.length === 0) {
        friendRequests.innerHTML = '<li class="empty-state">No pending requests</li>';
        return;
      }
      
      friendRequests.innerHTML = requests.map(req => {
        const user = req.from_user;
        const initials = getInitials(user.display_name || user.email);
        
        return `
          <li class="request-item">
            <div class="user-info">
              <div class="user-avatar-small">${initials}</div>
              <div class="user-details">
                <div class="name">${user.display_name || 'User'}</div>
                <div class="email">${user.email}</div>
              </div>
            </div>
            <div class="action-buttons">
              <button class="btn btn-primary btn-icon" onclick="acceptFriendRequest('${req.id}', '${req.from_user_id}')">Accept</button>
              <button class="btn btn-ghost btn-icon" onclick="rejectFriendRequest('${req.id}')">Decline</button>
            </div>
          </li>
        `;
      }).join('');
    } catch (e) {
      console.error('Error loading friend requests:', e);
    }
  }
  
  window.acceptFriendRequest = async function(requestId, friendUserId) {
    try {
      // Update request status
      const { error: updateError } = await supabase
        .from('friend_requests')
        .update({ status: 'accepted', updated_at: new Date().toISOString() })
        .eq('id', requestId);
      
      if (updateError) throw updateError;
      
      // Create bidirectional friendships
      const { error: friendship1Error } = await supabase
        .from('friendships')
        .insert({
          user_id: currentUser.id,
          friend_user_id: friendUserId
        });
      
      const { error: friendship2Error } = await supabase
        .from('friendships')
        .insert({
          user_id: friendUserId,
          friend_user_id: currentUser.id
        });
      
      if (friendship1Error || friendship2Error) throw friendship1Error || friendship2Error;
      
      // Refresh lists
      await loadFriendRequests();
      await loadFriends();
      showMessage('Friend request accepted!');
    } catch (e) {
      console.error('Error accepting friend request:', e);
      showMessage('Error accepting request', true);
    }
  };
  
  window.rejectFriendRequest = async function(requestId) {
    try {
      const { error } = await supabase
        .from('friend_requests')
        .update({ status: 'rejected', updated_at: new Date().toISOString() })
        .eq('id', requestId);
      
      if (error) throw error;
      
      await loadFriendRequests();
      showMessage('Friend request declined');
    } catch (e) {
      console.error('Error rejecting friend request:', e);
      showMessage('Error declining request', true);
    }
  };
  
  // =====================================================
  // Social Features - Friends List
  // =====================================================
  async function loadFriends() {
    if (!currentUser) return;
    
    try {
      const { data: friendships, error } = await supabase
        .from('friendships')
        .select(`
          *,
          friend:profiles!friendships_friend_user_id_fkey(id, email, display_name)
        `)
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false });
      
      if (error) throw error;
      
      if (!friendships || friendships.length === 0) {
        friendsList.innerHTML = '<li class="empty-state">No friends yet</li>';
        return;
      }
      
      friendsList.innerHTML = friendships.map(friendship => {
        const friend = friendship.friend;
        const initials = getInitials(friend.display_name || friend.email);
        
        return `
          <li class="friend-item">
            <div class="user-info">
              <div class="user-avatar-small">${initials}</div>
              <div class="user-details">
                <div class="name">${friend.display_name || 'User'}</div>
                <div class="email">${friend.email}</div>
              </div>
            </div>
            <div class="action-buttons">
              <button class="btn btn-ghost btn-icon" onclick="removeFriend('${friendship.id}', '${friend.id}')">Remove</button>
            </div>
          </li>
        `;
      }).join('');
    } catch (e) {
      console.error('Error loading friends:', e);
    }
  }
  
  window.removeFriend = async function(friendshipId, friendUserId) {
    if (!confirm('Are you sure you want to remove this friend?')) return;
    
    try {
      // Remove both directions of friendship
      await supabase
        .from('friendships')
        .delete()
        .eq('id', friendshipId);
      
      await supabase
        .from('friendships')
        .delete()
        .eq('user_id', friendUserId)
        .eq('friend_user_id', currentUser.id);
      
      await loadFriends();
      showMessage('Friend removed');
    } catch (e) {
      console.error('Error removing friend:', e);
      showMessage('Error removing friend', true);
    }
  };
  
  // Event listeners
  searchUsersBtn.addEventListener('click', searchUsers);
  userSearchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') searchUsers();
  });
  
  // Load default list ID
  async function loadDefaultList() {
    try {
      const { data } = await supabase
        .from('lists')
        .select('id')
        .eq('slug', 'nh48')
        .single();
      
      if (data) {
        currentListId = data.id;
      }
    } catch (e) {
      console.error('Error loading default list:', e);
    }
  }
  
  // Initialize social features after user loads
  async function initializeSocialFeatures() {
    await loadDefaultList();
    await loadRecentHikes();
    await loadFriendRequests();
    await loadFriends();
  }
  
  // Update loadUserProfile to call social features
  const originalLoadUserProfile = loadUserProfile;
  loadUserProfile = async function() {
    await originalLoadUserProfile();
    if (currentUser) {
      await initializeSocialFeatures();
    }
  };
</script>

</body>
</html>
