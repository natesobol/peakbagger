<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Profile Settings - Peakbagger's Journal</title>
<link rel="stylesheet" href="styles.css">
<style>
.profile-page {
  max-width: 800px;
  margin: 0 auto;
  padding: 40px 20px;
  min-height: 100vh;
  background: var(--bg);
}

.profile-header {
  margin-bottom: 32px;
}

.profile-header h1 {
  margin: 0 0 8px 0;
  color: var(--ink);
}

.profile-header .subtitle {
  color: var(--ink-weak);
  font-size: 14px;
}

.profile-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
}

.profile-card h2 {
  margin: 0 0 20px 0;
  font-size: 18px;
  color: var(--ink);
  border-bottom: 1px solid var(--border);
  padding-bottom: 12px;
}

.profile-avatar {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 24px;
}

.profile-avatar-icon {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), #6b8cff);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36px;
  color: white;
  font-weight: 600;
  border: 3px solid var(--border);
}

.profile-avatar-info h3 {
  margin: 0 0 4px 0;
  color: var(--ink);
  font-size: 20px;
}

.profile-avatar-info p {
  margin: 0;
  color: var(--ink-weak);
  font-size: 14px;
}

.info-grid {
  display: grid;
  gap: 16px;
}

.info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}

.info-item:last-child {
  border-bottom: none;
}

.info-item label {
  color: var(--ink-weak);
  font-size: 14px;
  font-weight: 500;
}

.info-item .value {
  color: var(--ink);
  font-weight: 500;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: var(--ink);
  font-weight: 500;
  font-size: 14px;
}

.form-group input {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--input-bg);
  color: var(--ink);
  font-size: 14px;
  transition: border-color 0.2s;
}

.form-group input:focus {
  outline: none;
  border-color: var(--accent);
}

.form-group .hint {
  margin-top: 6px;
  font-size: 13px;
  color: var(--ink-weak);
}

.btn-group {
  display: flex;
  gap: 12px;
  margin-top: 24px;
}

.message {
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 20px;
  font-size: 14px;
}

.message.success {
  background: rgba(61, 220, 132, 0.1);
  color: var(--good);
  border-left: 3px solid var(--good);
}

.message.error {
  background: rgba(255, 107, 107, 0.1);
  color: #ff6b6b;
  border-left: 3px solid #ff6b6b;
}

.danger-zone {
  margin-top: 32px;
  padding-top: 24px;
  border-top: 2px solid var(--border);
}

.danger-zone h3 {
  color: #ff6b6b;
  margin: 0 0 12px 0;
  font-size: 16px;
}

.danger-zone .btn-danger {
  background: rgba(255, 107, 107, 0.1);
  color: #ff6b6b;
  border: 1px solid #ff6b6b;
}

.danger-zone .btn-danger:hover {
  background: rgba(255, 107, 107, 0.2);
}

@media (max-width: 640px) {
  .profile-page {
    padding: 20px 16px;
  }
  
  .profile-avatar {
    flex-direction: column;
    text-align: center;
  }
  
  .btn-group {
    flex-direction: column;
  }
  
  .btn-group .btn {
    width: 100%;
  }
}
</style>
</head>
<body>

<div class="profile-page">
  <div class="profile-header">
    <button onclick="window.location.href='peakbagger-clean.html'" class="btn btn-ghost btn-small" style="margin-bottom: 16px;">
      ← Back to Peakbagger
    </button>
    <h1>Profile Settings</h1>
    <p class="subtitle">Manage your account information and security settings</p>
  </div>

  <!-- User Information Card -->
  <div class="profile-card">
    <h2>User Information</h2>
    
    <div class="profile-avatar">
      <div class="profile-avatar-icon" id="profileAvatarIcon">
        <span id="profileInitials">U</span>
      </div>
      <div class="profile-avatar-info">
        <h3 id="profileName">Loading...</h3>
        <p id="profileEmail">Loading...</p>
      </div>
    </div>

    <div class="info-grid">
      <div class="info-item">
        <label>Account Created</label>
        <span class="value" id="accountCreated">—</span>
      </div>
      <div class="info-item">
        <label>Last Sign In</label>
        <span class="value" id="lastSignIn">—</span>
      </div>
      <div class="info-item">
        <label>User ID</label>
        <span class="value subtle" id="userId" style="font-family: monospace; font-size: 12px;">—</span>
      </div>
    </div>
  </div>

  <!-- Change Password Card -->
  <div class="profile-card">
    <h2>Change Password</h2>
    
    <div id="passwordMessage" class="message" style="display: none;"></div>

    <form id="changePasswordForm">
      <div class="form-group">
        <label for="currentPassword">Current Password *</label>
        <input type="password" id="currentPassword" autocomplete="current-password" required>
      </div>

      <div class="form-group">
        <label for="newPassword">New Password *</label>
        <input type="password" id="newPassword" autocomplete="new-password" required>
        <p class="hint">Must be at least 6 characters</p>
      </div>

      <div class="form-group">
        <label for="confirmPassword">Confirm New Password *</label>
        <input type="password" id="confirmPassword" autocomplete="new-password" required>
      </div>

      <div class="btn-group">
        <button type="submit" class="btn btn-primary">Update Password</button>
        <button type="reset" class="btn btn-ghost">Cancel</button>
      </div>
    </form>
  </div>

  <!-- Danger Zone -->
  <div class="profile-card">
    <div class="danger-zone">
      <h3>⚠️ Danger Zone</h3>
      <p style="color: var(--ink-weak); font-size: 14px; margin: 0 0 16px 0;">
        These actions are permanent and cannot be undone.
      </p>
      <button class="btn btn-danger" id="signOutBtn">Sign Out</button>
    </div>
  </div>
</div>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script type="module">
  // Initialize Supabase with persistent session
  const supabaseUrl = 'https://uobvavnsstrgyezcklib.supabase.co';
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvYnZhdm5zc3RyZ3llemNrbGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0ODEzNTksImV4cCI6MjA4MTA1NzM1OX0.KL32AFytJcOC5RPEPlWlCzBDiA8N_Su9qb0yXT2n2ZI';
  
  const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      storage: window.localStorage
    }
  });

  let currentUser = null;

  // DOM elements
  const profileName = document.getElementById('profileName');
  const profileEmail = document.getElementById('profileEmail');
  const profileInitials = document.getElementById('profileInitials');
  const accountCreated = document.getElementById('accountCreated');
  const lastSignIn = document.getElementById('lastSignIn');
  const userId = document.getElementById('userId');
  const changePasswordForm = document.getElementById('changePasswordForm');
  const passwordMessage = document.getElementById('passwordMessage');
  const signOutBtn = document.getElementById('signOutBtn');

  // Load user data
  async function loadUserProfile() {
    const { data: { user }, error } = await supabase.auth.getUser();
    
    if (error || !user) {
      // Not logged in, redirect to main page
      window.location.href = 'peakbagger-clean.html';
      return;
    }

    currentUser = user;

    // Update UI with user data
    const firstName = user.user_metadata?.first_name || user.user_metadata?.name || 'User';
    const lastName = user.user_metadata?.last_name || '';
    const fullName = lastName ? `${firstName} ${lastName}` : firstName;

    profileName.textContent = fullName;
    profileEmail.textContent = user.email || '';
    userId.textContent = user.id;

    // Set initials
    const initials = firstName.charAt(0).toUpperCase() + (lastName ? lastName.charAt(0).toUpperCase() : '');
    profileInitials.textContent = initials || 'U';

    // Format dates
    if (user.created_at) {
      accountCreated.textContent = new Date(user.created_at).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    if (user.last_sign_in_at) {
      lastSignIn.textContent = new Date(user.last_sign_in_at).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
  }

  // Show message
  function showMessage(text, isError = false) {
    passwordMessage.textContent = text;
    passwordMessage.className = 'message ' + (isError ? 'error' : 'success');
    passwordMessage.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      passwordMessage.style.display = 'none';
    }, 5000);
  }

  // Handle password change
  changePasswordForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    // Validate passwords match
    if (newPassword !== confirmPassword) {
      showMessage('New passwords do not match', true);
      return;
    }

    // Validate password length
    if (newPassword.length < 6) {
      showMessage('Password must be at least 6 characters', true);
      return;
    }

    try {
      // First verify current password by trying to sign in
      const { error: signInError } = await supabase.auth.signInWithPassword({
        email: currentUser.email,
        password: currentPassword
      });

      if (signInError) {
        showMessage('Current password is incorrect', true);
        return;
      }

      // Update password
      const { error: updateError } = await supabase.auth.updateUser({
        password: newPassword
      });

      if (updateError) {
        showMessage(updateError.message, true);
        return;
      }

      // Success
      showMessage('Password updated successfully!');
      changePasswordForm.reset();
    } catch (err) {
      showMessage('An error occurred. Please try again.', true);
      console.error(err);
    }
  });

  // Handle sign out
  signOutBtn.addEventListener('click', async () => {
    if (!confirm('Are you sure you want to sign out?')) return;
    
    await supabase.auth.signOut();
    window.location.href = 'peakbagger-clean.html';
  });

  // Load profile on page load
  loadUserProfile();
</script>

</body>
</html>
