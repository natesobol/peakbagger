<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Peakbagger ‚Äì Peak stats, photos & routes</title>
  <meta name="author" content="Nathan Sobol" />
  <meta name="description" content="Elevation, prominence, difficulty, weather links and route info for White Mountain peaks in the NH 48, 52 With a View and other lists." />
  <meta name="keywords" content="NH 48 peaks, White Mountain hiking app, New Hampshire 4000 footers, summit stats, peak photos, hiking routes, peakbagger detail" />
  <meta name="robots" content="index,follow,max-image-preview:large" />
  <link rel="alternate" hreflang="en" href="https://nh48.app/pages/peak-detail.html" />
  <link rel="canonical" href="https://nh48.app/pages/peak-detail.html" id="canonicalLink">
  <link rel="icon" type="image/png" href="https://static.wixstatic.com/media/66b1b2_6dfce097ed584b5296afeb83f26e4c8a~mv2.png">
  <link rel="apple-touch-icon" href="https://static.wixstatic.com/media/66b1b2_6dfce097ed584b5296afeb83f26e4c8a~mv2.png">

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Peakbagger ‚Äì Peak stats, photos & routes" />
  <meta property="og:description" content="Elevation, prominence, difficulty, weather links and route info for White Mountain peaks in the NH 48, 52 With a View and other lists." />
  <meta property="og:url" content="https://nh48.app/pages/peak-detail.html" />
  <meta property="og:image" content="https://nh48pics.com/images/peakbagger-og.jpg" />
  <meta property="og:image:alt" content="White Mountain peak collage" />
  <meta property="og:site_name" content="Peakbagger's Journal" />
  <meta property="og:locale" content="en_US" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Peakbagger ‚Äì Peak stats, photos & routes" />
  <meta name="twitter:description" content="Elevation, prominence, difficulty, weather links and route info for White Mountain peaks in the NH 48, 52 With a View and other lists." />
  <meta name="twitter:image" content="https://nh48pics.com/images/peakbagger-og.jpg" />
  <meta name="twitter:site" content="@nh48app" />
  <meta name="twitter:creator" content="@nh48app" />

  <!-- JSON-LD: WebApplication -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Peakbagger's Journal ‚Äì Peak detail",
    "operatingSystem": "Web",
    "applicationCategory": "SportsApplication",
    "description": "Browse individual White Mountain peaks with elevations, routes, weather links, photos, and personal hike logs.",
    "url": "https://nh48.app/pages/peak-detail.html",
    "image": "https://nh48pics.com/images/peakbagger-og.jpg",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "publisher": {
      "@type": "Person",
      "name": "Nathan Sobol",
      "url": "https://www.nh48pics.com/"
    }
  }
  </script>

  <!-- JSON-LD: WebSite & Organization -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Peakbagger's Journal",
    "url": "https://nh48.app/",
    "alternateName": "NH48.app",
    "publisher": {
      "@type": "Organization",
      "name": "Peakbagger",
      "url": "https://nh48.app/",
      "logo": {
        "@type": "ImageObject",
        "url": "https://nh48.app/images/peakbagger-preview.png",
        "width": 1200,
        "height": 630
      },
      "sameAs": [
        "https://nh48pics.com",
        "https://nh48.info"
      ]
    },
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://nh48.app/pages/peak-detail.html?slug={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>

  <link rel="stylesheet" href="../css/peak-detail.css">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-o9N1j7kGStG3cJfWcJPrmnD/jYixQhMqLV+3lZ8Jp2o="
    crossorigin=""
  >
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o8EeYJtP0kCZo9zI0zYNbSLrGZM3Rp3yvRsI5u2y+5U="
    crossorigin=""
  ></script>
  <!-- URL Masking: hide /pages/ from URL bar -->
  <script>
  if (window.location.pathname.includes('/pages/')) {
    const params = window.location.search; // preserve ?peak=xxx
    // Clean URL without /pages/ subfolder
    history.replaceState(null, '', '/peak-detail' + params);
  }
  </script>
</head>
<body>
  <div class="wrap">
    <a href="/" class="back">‚Üê Back to Peakbagger</a>
    
    <h1 id="peakName">Loading‚Ä¶</h1>
    
    <!-- MEDIA / CAROUSEL -->
    <div class="media" id="media">
      <div class="carousel" id="carousel"></div>
      <div class="dots" id="dots"></div>
      <div class="ctrls">
        <button id="prevBtn" aria-label="Previous image">‚Äπ</button>
        <button id="nextBtn" aria-label="Next image">‚Ä∫</button>
      </div>
      <div class="timer" id="carouselTimer">
        <svg viewBox="0 0 40 40">
          <circle id="timerRing" class="timer-ring" cx="20" cy="20" r="18"></circle>
        </svg>
        <span id="timerText" class="timer-text"></span>
      </div>
    </div>
    
    <!-- METADATA: Peak Info -->
    <div id="fastFactsPanel" class="metadata-panel full-width">
      <div class="metadata-header">
        <div class="metadata-title">General Peak Info</div>
      </div>
      <div class="metadata-primary metadata-grid">
        <div class="metadata-row">
          <div class="metadata-label">Elevation</div>
          <div class="metadata-value" id="elevation">‚Äî</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Prominence</div>
          <div class="metadata-value" id="prominence">‚Äî</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Range</div>
          <div class="metadata-value" id="location">‚Äî</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Trail Type</div>
          <div class="metadata-value" id="trailType">‚Äî</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Difficulty</div>
          <div class="metadata-value" id="difficulty">‚Äî</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Exposure</div>
          <div class="metadata-value" id="exposure">‚Äî</div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn" id="favBtn"><span id="favIcon">‚òÜ</span> <span id="favText">Favorite</span></button>
        <button class="btn" id="wishBtn"><span id="wishIcon">ü§ç</span> <span id="wishText">Wishlist</span></button>
      </div>
      <div class="share-btn-row">
        <button class="btn share-wide-btn" id="sharePeakBtn">Share peak on social media</button>
      </div>
    </div>
    
    <!-- SUMMIT LOG + LEARN MORE SIDE BY SIDE -->
    <div class="meta-info-row">
      <!-- Summit Log Panel -->
      <div id="progressPanel" class="metadata-panel">
        <div class="metadata-header">
          <div class="metadata-title" id="summitLogTitle">Summit Log</div>
        </div>
        <div class="metadata-primary">
          <!-- Most recent summit entry - shows inline controls -->
          <div id="recentSummitEntry" class="summit-entry" style="display:none;">
            <div class="summit-entry-row">
              <input type="date" id="dateInput" class="date-input compact" />
              <button class="log-card-btn" id="editRecentBtn" title="Edit hike details">‚úèÔ∏è Edit</button>
              <button class="log-card-btn accent" id="socialRecentBtn" title="Create social card">üì∏ Social</button>
            </div>
          </div>
          <!-- Empty state when no summits -->
          <div id="noSummitEntry" class="no-summit-message">
            <span style="color:var(--muted);font-size:13px;">No summits logged yet</span>
          </div>
        </div>
        <div class="btn-row">
          <a href="#" class="btn log-hike-link">üìù Bag Peak</a>
        </div>
      </div>
      
      <!-- Learn More Panel -->
      <div class="info-panel">
        <div class="info-label">Learn More</div>
        <div class="links-col compact">
          <a class="btn-link primary" id="lnkNH48" href="#" target="_blank" rel="noopener" style="display:none">üèîÔ∏è View Full NH48 Peak Details ‚Üí</a>
          <a class="btn-link" id="lnkWikipedia" href="#" target="_blank" rel="noopener">Wikipedia</a>
          <a class="btn-link" id="lnkPeakbagger" href="#" target="_blank" rel="noopener">Peakbagger.com</a>
          <a class="btn-link" id="lnkAllTrails" href="#" target="_blank" rel="noopener">AllTrails</a>
          <a class="btn-link" id="wxNoaa" href="#" target="_blank" rel="noopener">NOAA Weather</a>
        </div>
      </div>
    </div>

    <!-- MAP PANEL -->
    <div id="mapPanel" class="metadata-panel full-width map-panel" style="display:none;">
      <div class="metadata-header">
        <div class="metadata-title">Trail Map</div>
        <div class="metadata-subtitle">OpenStreetMap view centered on this peak</div>
      </div>
      <div class="map-frame">
        <div id="peakMap" aria-label="OpenStreetMap preview for this peak"></div>
      </div>
    </div>

    <!-- HIKE LOG LIST - Full Width -->
    <div id="loggedProgressSection" class="logged-progress-section">
      <div class="section-title">Your Hike Log</div>
      <div id="loggedProgressContainer" class="logged-progress-container">
        <div class="loading-message">Loading hike history...</div>
      </div>
    </div>
    
    <!-- ADDITIONAL RESOURCES -->
    <div class="section-title">Additional Resources</div>
    <div class="info-grid two-col">
      <div class="info-panel">
        <div class="info-label">External Resources</div>
        <div class="links-col">
          <a class="btn-link" id="lnkSummitPost" href="#" target="_blank" rel="noopener">SummitPost</a>
          <a class="btn-link" id="lnkMaps" href="#" target="_blank" rel="noopener">OpenStreetMap</a>
        </div>
      </div>
      <div class="info-panel">
        <div class="info-label">Weather Forecasts</div>
        <div class="links-col">
          <a class="btn-link" id="wxOpenMeteo" href="#" target="_blank" rel="noopener">Open-Meteo</a>
          <a class="btn-link" href="https://www.mountwashington.org/experience-the-weather/" target="_blank" rel="noopener">MWOBS (Presidentials)</a>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // =====================================================
    // Supabase Configuration
    // =====================================================
    const SUPABASE_URL = 'https://uobvavnsstrgyezcklib.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvYnZhdm5zc3RyZ3llemNrbGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0ODEzNTksImV4cCI6MjA4MTA1NzM1OX0.KL32AFytJcOC5RPEPlWlCzBDiA8N_Su9qb0yXT2n2ZI';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storage: window.localStorage
      }
    });
    
    let currentUser = null;
    let currentPeakId = null;
    let currentPeakSlug = null;
    let currentPeakName = null;
    
    const params = new URLSearchParams(window.location.search);
    const peakSlug = params.get('slug');
    
    const API_URLS = [
      'https://cdn.jsdelivr.net/gh/natesobol/nh48-api@main/data/nh48.json',
      'https://raw.githubusercontent.com/natesobol/nh48-api/main/data/nh48.json'
    ];
    
    const PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(
      '<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#172032"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="22">No photos available</text></svg>'
    );

    let carouselImgs = [], carouselIdx = 0, carouselTimer = null, timerInterval = null;
    const BASE_DELAY = 8000;
    const MAP_DEFAULT_ZOOM = 12;
    let peakMap = null;
    let peakMapMarker = null;

    function setMetaContent(selector, value, attribute = 'content') {
      const tag = document.querySelector(selector);
      if (tag && value) {
        tag.setAttribute(attribute, value);
      }
    }

    function updateMetaTags(peak) {
      const title = peak.name ? `Peakbagger ‚Äì ${peak.name} stats, photos & routes` : 'Peakbagger ‚Äì Peak stats, photos & routes';
      const description = peak.name
        ? `Elevation, prominence, difficulty, weather links and route info for ${peak.name} in the White Mountains.`
        : 'Elevation, prominence, difficulty, weather links and route info for White Mountain peaks in the NH 48, 52 With a View and other lists.';
      const pageUrl = peak.slug ? `https://nh48.app/pages/peak-detail.html?slug=${encodeURIComponent(peak.slug)}` : 'https://nh48.app/pages/peak-detail.html';
      const primaryPhoto = Array.isArray(peak.photos) && peak.photos.length > 0
        ? (typeof peak.photos[0] === 'string' ? peak.photos[0] : peak.photos[0].url || peak.photos[0].src || peak.photos[0].image)
        : null;
      const imageUrl = primaryPhoto || 'https://nh48pics.com/images/peakbagger-og.jpg';
      const imageAlt = peak.name ? `${peak.name} summit photo` : 'White Mountain peak collage';

      document.title = title;
      const canonical = document.getElementById('canonicalLink');
      if (canonical) canonical.setAttribute('href', pageUrl);

      setMetaContent('meta[name="description"]', description);
      setMetaContent('meta[name="twitter:description"]', description);
      setMetaContent('meta[property="og:description"]', description);
      setMetaContent('meta[property="og:title"]', title);
      setMetaContent('meta[name="twitter:title"]', title);
      setMetaContent('meta[property="og:url"]', pageUrl);
      setMetaContent('meta[property="og:image"]', imageUrl);
      setMetaContent('meta[property="og:image:alt"]', imageAlt);
      setMetaContent('meta[name="twitter:image"]', imageUrl);
    }
    
    function cleanJSON(raw) {
      return raw.replace(/:contentReference\[.*?\]\{index=\d+\}/g, '').replace(/\/\*\s*Lines?\s+\d+[\d\-,\s]*omitted\s*\*\//g, '');
    }

    function hideMapPanel() {
      const mapPanel = document.getElementById('mapPanel');
      if (mapPanel) {
        mapPanel.style.display = 'none';
      }
    }

    function showPeakMap(lat, lon, peakName) {
      const mapPanel = document.getElementById('mapPanel');
      const mapEl = document.getElementById('peakMap');
      if (!mapPanel || !mapEl || typeof L === 'undefined') return;

      const center = [lat, lon];
      mapPanel.style.display = 'block';

      if (!peakMap) {
        peakMap = L.map(mapEl).setView(center, MAP_DEFAULT_ZOOM);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 18
        }).addTo(peakMap);
      } else {
        peakMap.setView(center, MAP_DEFAULT_ZOOM);
        if (peakMapMarker) {
          peakMap.removeLayer(peakMapMarker);
        }
      }

      peakMapMarker = L.marker(center).addTo(peakMap);
      if (peakName) {
        peakMapMarker.bindPopup(peakName).openPopup();
      }

      // Ensure Leaflet recalculates layout after panel becomes visible
      setTimeout(() => peakMap.invalidateSize(), 150);
    }

    async function fetchFromNH48API() {
      for (let i = 0; i < API_URLS.length; i++) {
        try {
          const res = await fetch(API_URLS[i], { mode: 'cors' });
          if (!res.ok) continue;
          const text = await res.text();
          return JSON.parse(cleanJSON(text));
        } catch (err) { console.log('Fetch error:', err); }
      }
      throw new Error('All API endpoints failed');
    }
    
    async function loadPeakData() {
      if (!peakSlug) { document.getElementById('peakName').textContent = 'Peak not found'; return; }
      
      try {
        const stored = localStorage.getItem('peakbagger_peaks');
        if (stored) {
          const peaks = JSON.parse(stored);
          const peak = peaks.find(p => p.slug === peakSlug);
          if (peak) {
            if (!peak.lat || !peak.lon) {
              const apiFallback = await fetchFromNH48API();
              const apiPeak = apiFallback?.[peakSlug];
              if (apiPeak) {
                peak.lat = apiPeak.latitude;
                peak.lon = apiPeak.longitude;
              }
            }
            renderPeak(peak);
            return;
          }
        }
        
        const data = await fetchFromNH48API();
        const apiPeak = data[peakSlug];
        
        if (apiPeak) {
          const peak = {
            slug: peakSlug,
            name: apiPeak.peakName || apiPeak['Peak Name'] || peakSlug,
            elevation: apiPeak['Elevation (ft)'] || apiPeak.elevation,
            location: apiPeak['Range / Subrange'] || apiPeak.range,
            prominence: apiPeak['Prominence (ft)'] || apiPeak.prominence,
            difficulty: apiPeak['Difficulty'] || apiPeak.difficulty,
            trailType: apiPeak['Trail Type'] || '',
            exposure: apiPeak['Exposure Level'] || apiPeak['Weather Exposure Rating'] || '',
            lat: apiPeak.latitude, lon: apiPeak.longitude,
            photos: apiPeak.photos || []
          };
          renderPeak(peak);
          return;
        }
        document.getElementById('peakName').textContent = 'Peak not found';
      } catch (err) {
        console.error('Error:', err);
        document.getElementById('peakName').textContent = 'Error loading peak';
      }
    }
    
    function renderPeak(peak) {
      currentPeakName = peak.name;  // Store for summit log panel
      document.getElementById('peakName').textContent = peak.name;
      updateMetaTags(peak);
      hideMapPanel();

      const lat = peak.lat !== undefined ? parseFloat(peak.lat) : NaN;
      const lon = peak.lon !== undefined ? parseFloat(peak.lon) : NaN;
      const hasCoords = Number.isFinite(lat) && Number.isFinite(lon);

      buildCarousel(peak);

      document.getElementById('elevation').textContent = peak.elevation ? `${peak.elevation}'` : '‚Äî';
      document.getElementById('prominence').textContent = peak.prominence ? `${peak.prominence}'` : '‚Äî';
      document.getElementById('location').textContent = peak.location || '‚Äî';
      document.getElementById('trailType').textContent = peak.trailType || '‚Äî';
      document.getElementById('difficulty').textContent = peak.difficulty || '‚Äî';
      document.getElementById('exposure').textContent = peak.exposure || '‚Äî';
      
      // Quick Log Date - loads from user_hike_logs and syncs changes back
      // This will be populated after we have the peak ID
      document.getElementById('dateInput').addEventListener('change', async (e) => {
        const newDate = e.target.value;
        await handleQuickLogDateChange(newDate);
      });
      
      const favorites = JSON.parse(localStorage.getItem('peakbagger_favorites') || '[]');
      const wishlist = JSON.parse(localStorage.getItem('peakbagger_wishlist') || '[]');
      updateFavBtn(favorites.includes(peak.slug));
      updateWishBtn(wishlist.includes(peak.slug));
      
      // Set up Log Hike button link
      document.querySelectorAll('.log-hike-link').forEach(link => {
        link.href = `/hike-log?peak=${peak.slug}`;
      });

      document.getElementById('favBtn').addEventListener('click', () => toggleFavorite(peak.slug));
      document.getElementById('wishBtn').addEventListener('click', () => toggleWishlist(peak.slug));
      const sharePeakBtn = document.getElementById('sharePeakBtn');
      if (sharePeakBtn) {
        sharePeakBtn.onclick = () => {
          if (currentPeakSlug && mostRecentLogId) {
            window.location.href = `/social-card?peak=${currentPeakSlug}&log=${mostRecentLogId}`;
          } else if (currentPeakSlug) {
            window.location.href = `/social-card?peak=${currentPeakSlug}`;
          }
        };
      }

      const wxNoaa = document.getElementById('wxNoaa');
      const wxOpenMeteo = document.getElementById('wxOpenMeteo');
      const mapsLink = document.getElementById('lnkMaps');

      if (hasCoords) {
        if (wxNoaa) {
          wxNoaa.href = `https://forecast.weather.gov/MapClick.php?lat=${lat}&lon=${lon}`;
          wxNoaa.style.display = '';
        }
        if (wxOpenMeteo) {
          wxOpenMeteo.href = `https://open-meteo.com/en/docs#latitude=${lat}&longitude=${lon}`;
          wxOpenMeteo.style.display = '';
        }
        if (mapsLink) {
          mapsLink.href = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}&zoom=14`;
          mapsLink.style.display = '';
        }
        showPeakMap(lat, lon, peak.name);
      } else {
        if (wxNoaa) wxNoaa.style.display = 'none';
        if (wxOpenMeteo) wxOpenMeteo.style.display = 'none';
        if (mapsLink) mapsLink.style.display = 'none';
      }

      const searchName = encodeURIComponent(peak.name);
      if (peak.slug) {
        const nh48Link = document.getElementById('lnkNH48');
        nh48Link.href = `https://natesobol.github.io/nh48-api/nh48_peak.html?slug=${peak.slug}`;
        nh48Link.style.display = 'block';
      }
      
      document.getElementById('lnkWikipedia').href = `https://en.wikipedia.org/wiki/${searchName}`;
      document.getElementById('lnkPeakbagger').href = `https://www.peakbagger.com/search.aspx?name=${searchName}`;
      document.getElementById('lnkAllTrails').href = `https://www.alltrails.com/search?q=${searchName}`;
      document.getElementById('lnkSummitPost').href = `https://www.summitpost.org/search?search=${searchName}`;
    }
    
    function buildCarousel(peak) {
      const carouselEl = document.getElementById('carousel');
      const dotsEl = document.getElementById('dots');
      carouselEl.innerHTML = ''; dotsEl.innerHTML = '';
      carouselImgs = []; carouselIdx = 0;
      
      let images = [];
      if (peak.photos && Array.isArray(peak.photos) && peak.photos.length > 0) {
        images = peak.photos.map(p => typeof p === 'string' ? p : (p && p.url ? p.url : null)).filter(Boolean);
      }
      if (images.length === 0) images = [PLACEHOLDER];
      carouselImgs = images;
      
      images.forEach((src, i) => {
        const slide = document.createElement('div');
        slide.className = 'slide' + (i === 0 ? ' active' : '');
        const img = document.createElement('img');
        img.alt = `${peak.name} image ${i + 1}`;
        if (i === 0) { img.src = src; } else { img.loading = 'lazy'; img.dataset.src = src; }
        slide.appendChild(img);
        carouselEl.appendChild(slide);
        
        const dot = document.createElement('div');
        dot.className = 'dot' + (i === 0 ? ' active' : '');
        dot.addEventListener('click', () => goToSlide(i));
        dotsEl.appendChild(dot);
      });
      
      if (images.length > 1) { startCarousel(); document.getElementById('carouselTimer').style.display = 'flex'; }
      else { document.getElementById('carouselTimer').style.display = 'none'; }
    }
    
    function goToSlide(index) {
      const slides = document.querySelectorAll('.slide');
      const dots = document.querySelectorAll('.dot');
      slides[carouselIdx].classList.remove('active');
      dots[carouselIdx].classList.remove('active');
      carouselIdx = index;
      const img = slides[carouselIdx].querySelector('img');
      if (img.dataset.src && !img.src) img.src = img.dataset.src;
      slides[carouselIdx].classList.add('active');
      dots[carouselIdx].classList.add('active');
      resetCarousel();
    }
    
    function nextSlide() { goToSlide((carouselIdx + 1) % carouselImgs.length); }
    function prevSlide() { goToSlide((carouselIdx - 1 + carouselImgs.length) % carouselImgs.length); }
    
    function startCarousel() {
      stopCarousel();
      const delay = BASE_DELAY + Math.random() * 2000;
      carouselTimer = setTimeout(nextSlide, delay);
      startTimer(delay);
    }
    
    function stopCarousel() {
      if (carouselTimer) { clearTimeout(carouselTimer); carouselTimer = null; }
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    }
    
    function resetCarousel() { startCarousel(); }
    
    function startTimer(duration) {
      const ring = document.getElementById('timerRing');
      const textEl = document.getElementById('timerText');
      const circumference = 2 * Math.PI * 18;
      ring.style.strokeDasharray = circumference;
      ring.style.strokeDashoffset = 0;
      const startTime = Date.now();
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const remaining = duration - (Date.now() - startTime);
        const percent = Math.max(0, remaining / duration);
        ring.style.strokeDashoffset = circumference * (1 - percent);
        textEl.textContent = remaining > 0 ? Math.ceil(remaining / 1000) : '';
        if (remaining <= 0) { clearInterval(timerInterval); timerInterval = null; }
      }, 100);
      textEl.textContent = Math.ceil(duration / 1000);
    }
    
    document.getElementById('prevBtn').addEventListener('click', prevSlide);
    document.getElementById('nextBtn').addEventListener('click', nextSlide);
    document.getElementById('media').addEventListener('mouseenter', stopCarousel);
    document.getElementById('media').addEventListener('mouseleave', () => { if (carouselImgs.length > 1) startCarousel(); });
    
    function toggleFavorite(slug) {
      const favorites = JSON.parse(localStorage.getItem('peakbagger_favorites') || '[]');
      const idx = favorites.indexOf(slug);
      if (idx > -1) favorites.splice(idx, 1); else favorites.push(slug);
      localStorage.setItem('peakbagger_favorites', JSON.stringify(favorites));
      updateFavBtn(favorites.includes(slug));
    }
    
    function updateFavBtn(isFavorite) {
      document.getElementById('favIcon').textContent = isFavorite ? '‚≠ê' : '‚òÜ';
      document.getElementById('favText').textContent = isFavorite ? 'Favorited' : 'Favorite';
    }
    
    function toggleWishlist(slug) {
      const wishlist = JSON.parse(localStorage.getItem('peakbagger_wishlist') || '[]');
      const idx = wishlist.indexOf(slug);
      if (idx > -1) wishlist.splice(idx, 1); else wishlist.push(slug);
      localStorage.setItem('peakbagger_wishlist', JSON.stringify(wishlist));
      updateWishBtn(wishlist.includes(slug));
    }
    
    function updateWishBtn(isWishlist) {
      document.getElementById('wishIcon').textContent = isWishlist ? '‚ù§Ô∏è' : 'ü§ç';
      document.getElementById('wishText').textContent = isWishlist ? 'Wishlisted' : 'Wishlist';
    }
    
    // =====================================================
    // Initialize User Session
    // DB Load: Check auth state
    // =====================================================
    async function initUserSession() {
      console.log('initUserSession: Checking auth state...');
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) {
        currentUser = session.user;
        console.log('initUserSession: User logged in:', currentUser.email);
      } else {
        console.log('initUserSession: No user logged in');
      }
    }
    
    // Store the most recent log ID for the summit panel buttons
    let mostRecentLogId = null;
    
    // =====================================================
    // Load Most Recent Summit for the Summit Log Panel
    // DB Load: user_hike_logs - Get most recent entry for this peak
    // =====================================================
    async function loadSummitLogPanel(peakName) {
      const dateInput = document.getElementById('dateInput');
      const recentEntry = document.getElementById('recentSummitEntry');
      const noEntry = document.getElementById('noSummitEntry');
      const titleEl = document.getElementById('summitLogTitle');
      const editBtn = document.getElementById('editRecentBtn');
      const socialBtn = document.getElementById('socialRecentBtn');
      
      // Update title with peak name
      if (titleEl && peakName) {
        titleEl.textContent = `${peakName} Summit`;
      }
      
      if (!currentUser || !currentPeakId) {
        console.log('loadSummitLogPanel: No user or peak ID');
        recentEntry.style.display = 'none';
        noEntry.style.display = 'block';
        noEntry.innerHTML = '<span style="color:var(--muted);font-size:13px;">Log in to track summits</span>';
        return;
      }
      
      try {
        console.log('loadSummitLogPanel: Fetching most recent hike for peak', currentPeakId);
        const { data: logs, error } = await supabase
          .from('user_hike_logs')
          .select('id, hike_date')
          .eq('user_id', currentUser.id)
          .eq('peak_id', currentPeakId)
          .order('hike_date', { ascending: false })
          .limit(1);
        
        if (error) {
          console.error('loadSummitLogPanel Error:', error);
          return;
        }
        
        if (logs && logs.length > 0) {
          mostRecentLogId = logs[0].id;
          dateInput.value = logs[0].hike_date || '';
          recentEntry.style.display = 'block';
          noEntry.style.display = 'none';
          
          // Wire up edit button
          editBtn.onclick = () => {
            if (currentPeakSlug && mostRecentLogId) {
              window.location.href = `/hike-log?peak=${currentPeakSlug}&edit=${mostRecentLogId}`;
            }
          };
          
          // Wire up social button
          socialBtn.onclick = () => {
            if (currentPeakSlug && mostRecentLogId) {
              window.location.href = `/social-card?peak=${currentPeakSlug}&log=${mostRecentLogId}`;
            }
          };
          
          console.log('loadSummitLogPanel: Set date to', logs[0].hike_date, 'logId:', mostRecentLogId);
        } else {
          mostRecentLogId = null;
          dateInput.value = '';
          recentEntry.style.display = 'none';
          noEntry.style.display = 'block';
          console.log('loadSummitLogPanel: No hikes found');
        }
      } catch (e) {
        console.error('loadSummitLogPanel Error:', e);
      }
    }
    
    // =====================================================
    // Handle Summit Date Change (creates new log entry)
    // DB Save: user_hike_logs - Create new entry
    // =====================================================
    async function handleQuickLogDateChange(newDate) {
      const dateInput = document.getElementById('dateInput');
      
      if (!currentUser) {
        alert('Please log in to track your hikes');
        dateInput.value = '';
        return;
      }
      
      if (!currentPeakId) {
        console.error('handleQuickLogDateChange: No peak ID');
        return;
      }
      
      // Show saving state
      dateInput.classList.add('saving');
      
      try {
        if (!newDate) {
          // Date cleared - don't delete logs, just clear the input
          console.log('handleQuickLogDateChange: Date cleared, hike logs preserved');
          dateInput.classList.remove('saving');
          return;
        }
        
        // Check if a log already exists for this date
        const { data: existing } = await supabase
          .from('user_hike_logs')
          .select('id')
          .eq('user_id', currentUser.id)
          .eq('peak_id', currentPeakId)
          .eq('hike_date', newDate)
          .maybeSingle();
        
        if (existing) {
          console.log('handleQuickLogDateChange: Log already exists for', newDate);
          dateInput.classList.remove('saving');
          dateInput.style.borderColor = 'var(--accent)';
          setTimeout(() => { dateInput.style.borderColor = ''; }, 500);
          return;
        }
        
        // Create new hike log entry
        console.log('handleQuickLogDateChange: Creating new log for', newDate);
        const { error: insertError } = await supabase
          .from('user_hike_logs')
          .insert({
            user_id: currentUser.id,
            peak_id: currentPeakId,
            hike_date: newDate,
            visibility: 'private',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          });
        
        if (insertError) {
          console.error('handleQuickLogDateChange Insert Error:', insertError);
          alert('Error saving hike: ' + insertError.message);
          dateInput.classList.remove('saving');
          return;
        }
        
        console.log('handleQuickLogDateChange: Created log successfully');
        
        // Visual feedback
        dateInput.classList.remove('saving');
        dateInput.style.borderColor = 'var(--accent)';
        setTimeout(() => { dateInput.style.borderColor = ''; }, 500);
        
        // Reload summit panel (to update the mostRecentLogId) and hike history
        await loadSummitLogPanel(currentPeakName);
        await loadHikeHistory();
        
      } catch (e) {
        console.error('handleQuickLogDateChange Error:', e);
        alert('Error saving hike: ' + e.message);
        dateInput.classList.remove('saving');
      }
    }
    
    // =====================================================
    // Load Hike History for this Peak
    // DB Load: user_hike_logs filtered by peak_id
    // =====================================================
    async function loadHikeHistory() {
      const section = document.getElementById('loggedProgressSection');
      const container = document.getElementById('loggedProgressContainer');
      
      // Always show the section
      section.style.display = 'block';
      
      // Error handling: Check user authentication
      if (!currentUser) {
        container.innerHTML = `
          <div class="no-logs-message">
            <div class="empty-icon">üîí</div>
            <div>Log in to track your hikes</div>
            <p style="margin-top:8px;font-size:12px;color:var(--muted)">Sign in to record and view your hike history for this peak</p>
          </div>
        `;
        return;
      }
      
      // Error handling: Check peak ID
      if (!currentPeakId) {
        console.log('loadHikeHistory: No peak ID yet, will retry after peak loads');
        return;
      }
      
      console.log('loadHikeHistory: Loading for peak', currentPeakId);
      container.innerHTML = '<div class="loading-message">Loading hike history...</div>';
      
      try {
        // =====================================================
        // DB Load: user_hike_logs - Get all logs for this peak
        // =====================================================
        console.log('DB Load: user_hike_logs - Fetching logs for peak', currentPeakId);
        const { data: logs, error } = await supabase
          .from('user_hike_logs')
          .select('*')
          .eq('user_id', currentUser.id)
          .eq('peak_id', currentPeakId)
          .order('hike_date', { ascending: false });
        
        if (error) {
          console.error('DB Load Error: user_hike_logs -', error);
          throw error;
        }
        
        console.log('DB Load Success: user_hike_logs -', logs?.length || 0, 'logs found');
        
        const logButton = `
          <div class="log-panel-header">
            <a href="${currentPeakSlug ? `/hike-log?peak=${currentPeakSlug}` : '#'}" class="btn log-hike-link log-panel-btn">üìù Bag Peak</a>
          </div>
        `;

        if (!logs || logs.length === 0) {
          container.innerHTML = `
            ${logButton}
            <div class="hike-log-scroll">
              <div class="no-logs-message">
                <div class="empty-icon">üìù</div>
                <div>No hike logs yet</div>
                <p style="margin-top:8px;font-size:12px;color:var(--muted)">Click "Bag Peak" above to record your first summit!</p>
              </div>
            </div>
          `;
          return;
        }

        // Render card-based log list with buttons
        const cardsHtml = `
          ${logButton}
          <div class="hike-log-scroll">
            <div class="hike-log-cards">
              ${logs.map(log => {
                const dateValue = log.hike_date || '';
                const formattedDate = dateValue ? new Date(dateValue + 'T00:00:00').toLocaleDateString('en-US', {
                  month: 'short', day: 'numeric', year: 'numeric'
                }) : 'No date';
                const notes = log.notes || '';
                const trailName = log.trail_name || '';
                const subtitle = trailName || (notes.length > 50 ? notes.substring(0, 50) + '...' : notes) || 'No details';

                return `
                  <div class="hike-log-card" data-log-id="${log.id}">
                    <div class="hike-log-card-main">
                      <div class="hike-log-date-section">
                        <input type="date"
                               class="log-date-input compact"
                               value="${dateValue}"
                               onchange="updateLogDate('${log.id}', this.value)"
                               title="Change date" />
                        <span class="hike-log-date-display">${formattedDate}</span>
                      </div>
                      <div class="hike-log-details">
                        <div class="hike-log-subtitle">${subtitle}</div>
                      </div>
                    </div>
                    <div class="hike-log-card-actions">
                      <button class="log-card-btn" onclick="editLog('${log.id}')" title="Edit hike details">
                        ‚úèÔ∏è Edit
                      </button>
                      <button class="log-card-btn accent" onclick="generateSocialCard('${log.id}')" title="Create social card with this date">
                        üì∏ Social Card
                      </button>
                      <button class="log-card-btn delete" onclick="deleteLog('${log.id}')" title="Delete this log">
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;

        container.innerHTML = cardsHtml;
        
      } catch (e) {
        console.error('loadHikeHistory Error:', e);
        container.innerHTML = `
          <div class="no-logs-message">
            <div class="empty-icon">‚ö†Ô∏è</div>
            <div>Error loading hike history</div>
            <p style="margin-top:8px;font-size:12px;color:var(--muted)">${e.message || 'Unknown error'}</p>
            <button onclick="loadHikeHistory()" class="log-action-btn" style="margin-top:12px">Try Again</button>
          </div>
        `;
      }
    }
    
    // =====================================================
    // Update Log Date
    // DB Save: user_hike_logs - Update hike_date
    // =====================================================
    async function updateLogDate(logId, newDate) {
      console.log('updateLogDate: Updating log', logId, 'to date', newDate);
      
      // Error handling: Check user authentication
      if (!currentUser) {
        alert('Please log in to update hike logs');
        return;
      }
      
      // Find the input and show saving state
      const row = document.querySelector(`tr[data-log-id="${logId}"]`);
      const input = row?.querySelector('.log-date-input');
      if (input) {
        input.classList.add('saving');
      }
      
      try {
        // =====================================================
        // DB Save: user_hike_logs - Update date
        // =====================================================
        console.log('DB Save: user_hike_logs - Updating date for log', logId);
        const { error } = await supabase
          .from('user_hike_logs')
          .update({ 
            hike_date: newDate,
            updated_at: new Date().toISOString()
          })
          .eq('id', logId)
          .eq('user_id', currentUser.id);
        
        if (error) {
          console.error('DB Save Error: user_hike_logs -', error);
          throw error;
        }
        
        console.log('DB Save Success: user_hike_logs - Date updated');
        
        // Brief visual feedback
        if (input) {
          input.style.borderColor = 'var(--accent)';
          setTimeout(() => {
            input.style.borderColor = '';
            input.classList.remove('saving');
          }, 500);
        }
        
      } catch (e) {
        console.error('updateLogDate Error:', e);
        alert('Error updating date: ' + e.message);
        if (input) {
          input.classList.remove('saving');
        }
        // Reload to restore original value
        loadHikeHistory();
      }
    }
    
    // =====================================================
    // Edit Log - Navigate to hike-log page
    // =====================================================
    function editLog(logId) {
      if (currentPeakSlug) {
        window.location.href = `/hike-log?peak=${currentPeakSlug}&edit=${logId}`;
      }
    }
    
    // =====================================================
    // Generate Social Card - Navigate to social card page
    // =====================================================
    function generateSocialCard(logId) {
      if (currentPeakSlug) {
        window.location.href = `/social-card?peak=${currentPeakSlug}&log=${logId}`;
      }
    }
    
    // =====================================================
    // Delete Log
    // DB Save: user_hike_logs - Delete entry
    // =====================================================
    async function deleteLog(logId) {
      // Error handling: Check user authentication
      if (!currentUser) {
        alert('Please log in to delete hike logs');
        return;
      }
      
      if (!confirm('Are you sure you want to delete this hike log?')) {
        return;
      }
      
      console.log('deleteLog: Deleting log', logId);
      
      try {
        // =====================================================
        // DB Save: user_hike_logs - Delete entry
        // =====================================================
        console.log('DB Save: user_hike_logs - Deleting log', logId);
        const { error } = await supabase
          .from('user_hike_logs')
          .delete()
          .eq('id', logId)
          .eq('user_id', currentUser.id);
        
        if (error) {
          console.error('DB Save Error: user_hike_logs -', error);
          throw error;
        }
        
        console.log('DB Save Success: user_hike_logs - Log deleted');
        
        // Reload the summit panel (might need to show different entry now)
        await loadSummitLogPanel(currentPeakName);
        // Reload the hike history list
        await loadHikeHistory();
        
      } catch (e) {
        console.error('deleteLog Error:', e);
        alert('Error deleting log: ' + e.message);
      }
    }
    
    // =====================================================
    // Get Peak ID from Supabase by slug
    // DB Load: peaks - Get peak UUID
    // =====================================================
    async function getPeakIdBySlug(slug) {
      console.log('getPeakIdBySlug: Looking up peak', slug);
      
      try {
        // =====================================================
        // DB Load: peaks - Get peak by slug
        // =====================================================
        console.log('DB Load: peaks - Fetching peak by slug');
        const { data: peak, error } = await supabase
          .from('peaks')
          .select('id')
          .eq('slug', slug)
          .single();
        
        if (error) {
          console.error('DB Load Error: peaks -', error);
          return null;
        }
        
        console.log('DB Load Success: peaks - Found peak ID:', peak?.id);
        return peak?.id || null;
        
      } catch (e) {
        console.error('getPeakIdBySlug Error:', e);
        return null;
      }
    }
    
    // Scroll to top when page loads
    window.scrollTo(0, 0);
    
    // Initialize
    async function init() {
      await initUserSession();
      await loadPeakData();
      
      // Get peak ID and load summit log + hike history
      if (peakSlug) {
        currentPeakSlug = peakSlug;
        currentPeakId = await getPeakIdBySlug(peakSlug);
        if (currentPeakId) {
          // Load the Summit Log panel with most recent entry
          await loadSummitLogPanel(currentPeakName);
          // Load full hike history list
          await loadHikeHistory();
        } else {
          // Still show panel title even if no peak ID
          loadSummitLogPanel(currentPeakName);
        }
      }
    }
    
    init();
  </script>
</body>
</html>