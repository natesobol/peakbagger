<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generate Social Card ‚Äì Peakbagger‚Äôs Journal</title>
  <meta name="description" content="Create a shareable summit image from your Peakbagger hikes with elevation, date, and location details for the NH 48 and other peak lists." />
  <meta name="keywords" content="Peakbagger social card, summit image generator, NH 48 share card, hiking achievements" />
  <link rel="canonical" href="https://nh48.app/pages/social-card.html" />
  <meta name="robots" content="index,follow,max-image-preview:large" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://nh48.app/pages/social-card.html" />
  <meta property="og:title" content="Generate Social Card ‚Äì Peakbagger‚Äôs Journal" />
  <meta property="og:description" content="Turn your NH 48 and White Mountain hikes into a social-ready card with summit stats and photos." />
  <meta property="og:image" content="https://nh48pics.com/images/peakbagger-og.jpg" />
  <meta property="og:image:alt" content="NH 4000 footers peaks overview with progress bar" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Generate Social Card ‚Äì Peakbagger‚Äôs Journal" />
  <meta name="twitter:description" content="Turn your NH 48 and White Mountain hikes into a social-ready card with summit stats and photos." />
  <meta name="twitter:image" content="https://nh48pics.com/images/peakbagger-og.jpg" />

  <!-- JSON-LD: SoftwareApplication -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Peakbagger‚Äôs Journal",
    "operatingSystem": "Web",
    "applicationCategory": "SportsApplication",
    "description": "Free hiking log for tracking New Hampshire‚Äôs 4000 footers, 52 With a View and other peak lists. Search, sort, filter and record your climbs and dates.",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "url": "https://nh48.app/pages/social-card.html",
    "image": "https://nh48pics.com/images/peakbagger-og.jpg",
    "publisher": {
      "@type": "Person",
      "name": "Nathan Sobol",
      "url": "https://www.nh48pics.com/"
    }
  }
  </script>
  <link rel="stylesheet" href="../css/social-card.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>

<div class="social-card-page">
  <div class="page-header">
    <a href="javascript:history.back()" class="back-link">‚Üê Back</a>
    <h1>Generate Social Card</h1>
    <p class="subtitle">Create a shareable image of your summit achievement</p>
  </div>

  <!-- Preview Section -->
  <div class="preview-section">
    <div class="preview-label">Preview</div>
      <div class="preview-container">
        <div id="socialCard" class="social-card">
        <!-- Background Image -->
        <div class="card-image" id="cardImage">
          <img src="" alt="Peak" id="peakImage" crossorigin="anonymous" />
          <div class="image-overlay"></div>
        </div>
        
        <!-- Info Panel -->
          <div class="card-info-panel">
            <div class="card-user-name" id="cardUserName"></div>

          <div class="card-badge" id="cardBadge">
            <span class="badge-icon">üèîÔ∏è</span>
            <span class="badge-text">SUMMIT ACHIEVED</span>
          </div>
          
          <h2 class="card-peak-name" id="cardPeakName">Loading...</h2>
          
          <div class="card-stats">
            <div class="card-stat">
              <span class="stat-icon">üìÖ</span>
              <span class="stat-value" id="cardDate">‚Äî</span>
            </div>
            <div class="card-stat">
              <span class="stat-icon">‚õ∞Ô∏è</span>
              <span class="stat-value" id="cardElevation">‚Äî</span>
            </div>
            <div class="card-stat">
              <span class="stat-icon">üìç</span>
              <span class="stat-value" id="cardLocation">‚Äî</span>
            </div>
          </div>
          
          <div class="card-secondary-stats" id="cardSecondaryStats">
            <!-- Optional: miles, elevation gain, weather -->
          </div>
          
          <div class="card-footer">
            <span class="footer-brand">Peakbagger's Journal</span>
            <span class="footer-url">nh48.app</span>
          </div>
        </div>
        <div class="photo-toolbar" id="photoToolbar" style="display:none;">
          <div class="photo-toolbar-label">Swap image</div>
          <div class="photo-toolbar-controls">
            <button type="button" class="photo-btn" onclick="cyclePhoto(-1)">‚óÄ</button>
            <span class="photo-counter" id="photoCounter">1/1</span>
            <button type="button" class="photo-btn" onclick="cyclePhoto(1)">‚ñ∂</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Controls Section -->
  <div class="controls-section">
    <div class="control-group">
      <label>Card Style</label>
      <div class="style-options">
        <button class="style-btn active" data-style="dark" onclick="setCardStyle('dark')">Dark</button>
        <button class="style-btn" data-style="light" onclick="setCardStyle('light')">Light</button>
        <button class="style-btn" data-style="gradient" onclick="setCardStyle('gradient')">Gradient</button>
      </div>
    </div>
    
    <div class="control-group">
      <label>Show Optional Info</label>
      <div class="toggle-options">
        <label class="toggle-option">
          <input type="checkbox" id="showMiles" onchange="updateCard()" />
          <span>Distance</span>
        </label>
        <label class="toggle-option">
          <input type="checkbox" id="showElevGain" onchange="updateCard()" />
          <span>Elevation Gain</span>
        </label>
        <label class="toggle-option">
          <input type="checkbox" id="showWeather" onchange="updateCard()" />
          <span>Weather</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <button class="btn btn-primary" onclick="downloadCard()">
      <span class="btn-icon">üì•</span>
      Download Image
    </button>
    <button class="btn btn-secondary" onclick="copyToClipboard()">
      <span class="btn-icon">üìã</span>
      Copy to Clipboard
    </button>
  </div>
  
  <!-- Status Message -->
  <div id="statusMessage" class="status-message" style="display:none;"></div>
</div>

<script>
  // =====================================================
  // Supabase Configuration
  // =====================================================
  const SUPABASE_URL = 'https://jyvlwkxcrqprjdlnhqms.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5dmx3a3hjcnFwcmpkbG5ocW1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU2MDEzODksImV4cCI6MjA2MTE3NzM4OX0.DK0FPbAGdXBsmdy6VzoGLO2sXL0bxMh0VHnJ9xI5lfo';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  const API_URLS = [
    'https://cdn.jsdelivr.net/gh/natesobol/nh48-api@main/data/nh48.json',
    'https://raw.githubusercontent.com/natesobol/nh48-api/main/data/nh48.json'
  ];
  
  const PLACEHOLDER_IMAGE = 'data:image/svg+xml;utf8,' + encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#1a1a24"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="22">No photo available</text></svg>'
  );
  
  let currentUser = null;
  let peakData = null;
  let hikeLogData = null;
  let cardPhotos = [];
  let currentPhotoIndex = 0;
  let cardStyle = 'dark';
  
  // Parse URL params
  const params = new URLSearchParams(window.location.search);
  const peakSlug = params.get('peak');
  const logId = params.get('log');
  const progressId = params.get('progress');
  let peakDbId = null;
  
  // =====================================================
  // Initialize
  // =====================================================
  async function init() {
    console.log('Initializing social card generator...');
    console.log('Params:', { peakSlug, logId, progressId });
    
    // Check auth
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user) {
      currentUser = session.user;
    }
    
    // Load peak data
    if (peakSlug) {
      await loadPeakData(peakSlug);
    }

    // Prepare photos once peak data is available
    buildCardPhotos();
    
    // Load hike log data if provided
    if (logId && currentUser) {
      await loadHikeLogData(logId);
    } else if (progressId && currentUser) {
      await loadProgressData(progressId);
    } else if (currentUser && peakDbId) {
      await loadLatestLogForPeak();
    }
    
    // Render the card
    updateCard();
  }
  
  // =====================================================
  // Load Peak Data from API
  // =====================================================
  async function loadPeakData(slug) {
    console.log('Loading peak data for:', slug);

    try {
      let apiPeakFound = false;

      // Try localStorage first
      const stored = localStorage.getItem('peakbagger_peaks');
      if (stored) {
        const peaks = JSON.parse(stored);
        const peak = peaks.find(p => p.slug === slug);
        if (peak) {
          peakData = peak;
          apiPeakFound = true;
        }
      }

      // Fetch from API if needed
      if (!apiPeakFound) {
        for (let i = 0; i < API_URLS.length; i++) {
          try {
            const res = await fetch(API_URLS[i], { mode: 'cors' });
            if (!res.ok) continue;
            const text = await res.text();
            const data = JSON.parse(text.replace(/:contentReference\[.*?\]\{index=\d+\}/g, ''));
            const apiPeak = data[slug];

            if (apiPeak) {
              peakData = {
                slug: slug,
                name: apiPeak.peakName || apiPeak['Peak Name'] || slug,
                elevation: apiPeak['Elevation (ft)'] || apiPeak.elevation,
                location: apiPeak['Range / Subrange'] || apiPeak.range,
                prominence: apiPeak['Prominence (ft)'] || apiPeak.prominence,
                difficulty: apiPeak['Difficulty'] || apiPeak.difficulty,
                photos: apiPeak.photos || []
              };
              apiPeakFound = true;
              break;
            }
          } catch (err) {
            console.log('API fetch error:', err);
          }
        }
      }

      // Pull ID and any enriched data from Supabase for log lookups
      const { data: dbPeak } = await supabase
        .from('peaks')
        .select('id, slug, name, elevation_ft, range, state, photos')
        .eq('slug', slug)
        .single();

      if (dbPeak) {
        peakDbId = dbPeak.id;
        if (!peakData) peakData = {};
        peakData = {
          ...peakData,
          slug: dbPeak.slug || peakData.slug || slug,
          name: dbPeak.name || peakData.name,
          elevation: dbPeak.elevation_ft || peakData.elevation,
          location: dbPeak.range || dbPeak.state || peakData.location,
          photos: Array.isArray(dbPeak.photos) && dbPeak.photos.length ? dbPeak.photos : (peakData.photos || [])
        };
      }
    } catch (e) {
      console.error('Error loading peak data:', e);
    }
  }

  async function loadLatestLogForPeak() {
    if (!currentUser || !peakDbId) return;

    try {
      const { data: logs, error } = await supabase
        .from('user_hike_logs')
        .select('*')
        .eq('user_id', currentUser.id)
        .eq('peak_id', peakDbId)
        .order('hike_date', { ascending: false })
        .limit(1);

      if (error) {
        console.error('loadLatestLogForPeak error:', error);
        return;
      }

      if (logs && logs.length) {
        hikeLogData = logs[0];
        if (logs[0]?.peak_id) {
          peakDbId = logs[0].peak_id;
        }
        setOptionalTogglesFromData();
      }
    } catch (e) {
      console.error('Error fetching latest log for peak:', e);
    }
  }

  function buildCardPhotos() {
    cardPhotos = Array.isArray(peakData?.photos)
      ? peakData.photos
        .map(p => typeof p === 'string' ? p : (p?.url || p?.src || p?.image || null))
        .filter(Boolean)
      : [];
    currentPhotoIndex = 0;
  }
  
  // =====================================================
  // Load Hike Log Data
  // DB Load: user_hike_logs
  // =====================================================
  async function loadHikeLogData(id) {
    console.log('DB Load: user_hike_logs - Loading log:', id);
    
    try {
      const { data: log, error } = await supabase
        .from('user_hike_logs')
        .select('*')
        .eq('id', id)
        .eq('user_id', currentUser.id)
        .single();

      if (error || !log) {
        console.error('DB Load Error:', error || 'No log found');
        showStatus('Could not load that hike from your account.', true);
        return;
      }

      hikeLogData = log;
      if (log?.peak_id) {
        peakDbId = log.peak_id;
      }
      setOptionalTogglesFromData();
      console.log('DB Load Success: Hike log loaded');
    } catch (e) {
      console.error('Error loading hike log:', e);
    }
  }
  
  // =====================================================
  // Load Progress Data (for entries without full hike log)
  // DB Load: user_peak_progress
  // =====================================================
  async function loadProgressData(id) {
    console.log('DB Load: user_peak_progress - Loading progress:', id);
    
    try {
      const { data: progress, error } = await supabase
        .from('user_peak_progress')
        .select('*')
        .eq('id', id)
        .eq('user_id', currentUser.id)
        .single();

      if (error || !progress) {
        console.error('DB Load Error:', error || 'Progress not found');
        showStatus('Could not load that peak progress entry.', true);
        return;
      }
      
      // Convert progress to hike log format for display
      // Extract just the date part if it's a timestamp
      let dateValue = progress.first_completed_at || progress.last_completed_at;
      if (dateValue && dateValue.includes('T')) {
        dateValue = dateValue.split('T')[0];
      }
      hikeLogData = {
        hike_date: dateValue,
        peak_id: progress.peak_id
      };
      peakDbId = progress.peak_id;
      await loadLatestLogForPeak();
      console.log('DB Load Success: Progress loaded, date:', dateValue);
    } catch (e) {
      console.error('Error loading progress:', e);
    }
  }

  function setOptionalTogglesFromData() {
    if (!hikeLogData) return;
    const hasMiles = !!hikeLogData.miles;
    const hasGain = !!hikeLogData.elevation_gain_ft;
    const hasTemp = !!hikeLogData.temperature;

    if (hasMiles) document.getElementById('showMiles').checked = true;
    if (hasGain) document.getElementById('showElevGain').checked = true;
    if (hasTemp) document.getElementById('showWeather').checked = true;
  }
  
  // =====================================================
  // Update Card Display
  // =====================================================
  function updateCard() {
    const card = document.getElementById('socialCard');
    const peakImage = document.getElementById('peakImage');
    const userNameEl = document.getElementById('cardUserName');
    const peakName = document.getElementById('cardPeakName');
    const dateEl = document.getElementById('cardDate');
    const elevationEl = document.getElementById('cardElevation');
    const locationEl = document.getElementById('cardLocation');
    const secondaryStats = document.getElementById('cardSecondaryStats');
    const badgeEl = document.getElementById('cardBadge');
    const badgeIcon = badgeEl?.querySelector('.badge-icon');
    const badgeText = badgeEl?.querySelector('.badge-text');
    
    // Set user display name
    if (currentUser) {
      const firstName = currentUser.user_metadata?.first_name || currentUser.user_metadata?.name || '';
      const lastName = currentUser.user_metadata?.last_name || '';
      const displayName = lastName ? `${firstName} ${lastName}` : firstName;
      userNameEl.textContent = displayName || currentUser.email?.split('@')[0] || '';
    }
    
    // Set peak image
    if (cardPhotos.length === 0 && peakData?.photos?.length) {
      buildCardPhotos();
    }

    const selectedPhoto = cardPhotos[currentPhotoIndex] || PLACEHOLDER_IMAGE;
    peakImage.src = selectedPhoto;
    peakImage.onerror = () => { peakImage.src = PLACEHOLDER_IMAGE; };

    const photoToolbar = document.getElementById('photoToolbar');
    const photoCounter = document.getElementById('photoCounter');
    if (cardPhotos.length > 1) {
      photoToolbar.style.display = 'flex';
      photoCounter.textContent = `${currentPhotoIndex + 1}/${cardPhotos.length}`;
    } else {
      photoToolbar.style.display = 'none';
    }
    
    // Set peak name
    peakName.textContent = peakData?.name || 'Unknown Peak';
    
    // Set date - handle various date formats
    let dateStr = hikeLogData?.hike_date;
    if (dateStr) {
      // Handle ISO timestamps by extracting just the date part
      if (dateStr.includes('T')) {
        dateStr = dateStr.split('T')[0];
      }
      // Parse as local date (YYYY-MM-DD)
      const [year, month, day] = dateStr.split('-').map(Number);
      const date = new Date(year, month - 1, day);
      dateEl.textContent = date.toLocaleDateString('en-US', {
        month: 'long', day: 'numeric', year: 'numeric'
      });
      badgeEl?.classList.remove('todo');
      if (badgeText) badgeText.textContent = 'SUMMIT ACHIEVED';
      if (badgeIcon) badgeIcon.textContent = 'üèîÔ∏è';
    } else {
      dateEl.textContent = '‚Äî';
      badgeEl?.classList.add('todo');
      if (badgeText) badgeText.textContent = 'TO-DO';
      if (badgeIcon) badgeIcon.textContent = 'üó∫Ô∏è';
    }
    
    // Set elevation
    elevationEl.textContent = peakData?.elevation ? `${peakData.elevation.toLocaleString()}' elevation` : '‚Äî';
    
    // Set location
    locationEl.textContent = peakData?.location || '‚Äî';
    
    // Build secondary stats
    let secondaryHtml = '';
    
    if (document.getElementById('showMiles').checked && hikeLogData?.miles) {
      secondaryHtml += `<div class="secondary-stat"><span>ü•æ</span> ${hikeLogData.miles} miles</div>`;
    }

    if (document.getElementById('showElevGain').checked && hikeLogData?.elevation_gain_ft) {
      secondaryHtml += `<div class="secondary-stat"><span>üìà</span> ${hikeLogData.elevation_gain_ft.toLocaleString()}' gain</div>`;
    }

    if (document.getElementById('showWeather').checked && (hikeLogData?.temperature || hikeLogData?.precipitation || hikeLogData?.wind)) {
      const weatherBits = [];
      if (hikeLogData.temperature) weatherBits.push(hikeLogData.temperature);
      if (hikeLogData.precipitation) weatherBits.push(hikeLogData.precipitation);
      if (hikeLogData.wind) weatherBits.push(hikeLogData.wind);
      secondaryHtml += `<div class="secondary-stat"><span>üå§Ô∏è</span> ${weatherBits.join(' ¬∑ ')}</div>`;
    }
    
    secondaryStats.innerHTML = secondaryHtml;
  }

  function cyclePhoto(direction) {
    if (!cardPhotos.length) return;
    currentPhotoIndex = (currentPhotoIndex + direction + cardPhotos.length) % cardPhotos.length;
    updateCard();
  }
  
  // =====================================================
  // Set Card Style
  // =====================================================
  function setCardStyle(style) {
    cardStyle = style;
    const card = document.getElementById('socialCard');
    
    // Remove all style classes
    card.classList.remove('style-dark', 'style-light', 'style-gradient');
    card.classList.add(`style-${style}`);
    
    // Update active button
    document.querySelectorAll('.style-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.style === style);
    });
  }
  
  // =====================================================
  // Download Card as Image
  // =====================================================
  async function downloadCard() {
    showStatus('Generating image...', false);
    
    try {
      const card = document.getElementById('socialCard');
      
      const canvas = await html2canvas(card, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: null,
        logging: false
      });
      
      // Create download link
      const link = document.createElement('a');
      const peakSlugName = peakData?.slug || 'peak';
      const dateStr = hikeLogData?.hike_date ? hikeLogData.hike_date.replace(/-/g, '') : 'summit';
      link.download = `${peakSlugName}-${dateStr}-social.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      
      showStatus('Image downloaded!', false);
    } catch (e) {
      console.error('Error generating image:', e);
      showStatus('Error generating image: ' + e.message, true);
    }
  }
  
  // =====================================================
  // Copy to Clipboard
  // =====================================================
  async function copyToClipboard() {
    showStatus('Copying to clipboard...', false);
    
    try {
      const card = document.getElementById('socialCard');
      
      const canvas = await html2canvas(card, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: null,
        logging: false
      });
      
      canvas.toBlob(async (blob) => {
        try {
          await navigator.clipboard.write([
            new ClipboardItem({ 'image/png': blob })
          ]);
          showStatus('Copied to clipboard!', false);
        } catch (e) {
          console.error('Clipboard error:', e);
          showStatus('Could not copy to clipboard. Try downloading instead.', true);
        }
      }, 'image/png');
    } catch (e) {
      console.error('Error generating image:', e);
      showStatus('Error generating image: ' + e.message, true);
    }
  }
  
  // =====================================================
  // Show Status Message
  // =====================================================
  function showStatus(message, isError) {
    const el = document.getElementById('statusMessage');
    el.textContent = message;
    el.className = 'status-message ' + (isError ? 'error' : 'success');
    el.style.display = 'block';
    
    if (!isError) {
      setTimeout(() => { el.style.display = 'none'; }, 3000);
    }
  }
  
  // Initialize on load
  init().catch(err => {
    console.error('Social card init failed:', err);
    showStatus('Unable to load social card data. Please try again.', true);
  });
</script>

</body>
</html>
